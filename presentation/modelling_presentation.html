<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Filip Šajtlava, Vojtěch Andrle">
<meta name="dcterms.date" content="2025-12-10">

<title>Rossmann sales prediction</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="modelling_presentation_files/libs/clipboard/clipboard.min.js"></script>
<script src="modelling_presentation_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="modelling_presentation_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="modelling_presentation_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="modelling_presentation_files/libs/quarto-html/popper.min.js"></script>
<script src="modelling_presentation_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="modelling_presentation_files/libs/quarto-html/anchor.min.js"></script>
<link href="modelling_presentation_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="modelling_presentation_files/libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="modelling_presentation_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="modelling_presentation_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="modelling_presentation_files/libs/bootstrap/bootstrap-c963cad8bd1347d1a852185b92e428da.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="modelling_presentation_files/libs/quarto-diagram/mermaid.min.js"></script>
<script src="modelling_presentation_files/libs/quarto-diagram/mermaid-init.js"></script>
<link href="modelling_presentation_files/libs/quarto-diagram/mermaid.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#modeling" id="toc-modeling" class="nav-link active" data-scroll-target="#modeling">3 Modeling</a>
  <ul class="collapse">
  <li><a href="#model-selection" id="toc-model-selection" class="nav-link" data-scroll-target="#model-selection">3.1 Model Selection</a>
  <ul class="collapse">
  <li><a href="#data-preparation-again" id="toc-data-preparation-again" class="nav-link" data-scroll-target="#data-preparation-again">3.1.1 Data Preparation (again)</a></li>
  <li><a href="#modeling-approach" id="toc-modeling-approach" class="nav-link" data-scroll-target="#modeling-approach">3.1.2 Modeling Approach</a></li>
  </ul></li>
  <li><a href="#random-forests" id="toc-random-forests" class="nav-link" data-scroll-target="#random-forests">3.2 Random Forests</a>
  <ul class="collapse">
  <li><a href="#naive-modeling" id="toc-naive-modeling" class="nav-link" data-scroll-target="#naive-modeling">3.2.1 Naive Modeling</a></li>
  <li><a href="#recursive-modeling" id="toc-recursive-modeling" class="nav-link" data-scroll-target="#recursive-modeling">3.2.2 Recursive Modeling</a></li>
  </ul></li>
  <li><a href="#gradient-boosting---lightgbm" id="toc-gradient-boosting---lightgbm" class="nav-link" data-scroll-target="#gradient-boosting---lightgbm">3.3 Gradient Boosting - LightGBM</a></li>
  <li><a href="#neural-networks---classic-mlp" id="toc-neural-networks---classic-mlp" class="nav-link" data-scroll-target="#neural-networks---classic-mlp">3.4 Neural Networks - classic MLP</a></li>
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results">3.5 Results</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Rossmann sales prediction</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Show the code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Filip Šajtlava, Vojtěch Andrle </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 10, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="modeling" class="level1">
<h1>3 Modeling</h1>
<section id="model-selection" class="level2">
<h2 class="anchored" data-anchor-id="model-selection">3.1 Model Selection</h2>
<p>We compare three models in our analysis:</p>
<ol type="i">
<li><strong>Random Forests</strong>,</li>
<li><strong>LightGBM</strong>,</li>
<li><strong>Neural Networks</strong>.</li>
</ol>
<p>To evaluate their performance, we use the Root Mean Squared Percentage Error (<span class="math inline">\(\text{RMSPE}\)</span>), defined as: <span class="math display">\[ \text{RMSPE}(\mathbf{y}, \mathbf{\widehat{y}}) = \sqrt{\frac{1}{n} \sum_{i=1}^n \left( \frac{y_i - \widehat{y}_i}{y_i} \right)^2}\]</span></p>
<p>The best achieved performance on this dataset was <span class="math inline">\(\text{RMSPE} \approx 0.10\)</span>. We keep this benchmark in mind when comparing our own models.</p>
<section id="data-preparation-again" class="level3">
<h3 class="anchored" data-anchor-id="data-preparation-again">3.1.1 Data Preparation (again)</h3>
<p>Due to autocorrelation, it is useful to include recent sales information (along with their corresponding dummy availability variables):</p>
<ul>
<li><span class="math inline">\(SalesLag1\)</span></li>
<li><span class="math inline">\(SalesLag2\)</span></li>
<li><span class="math inline">\(RollingMean7\)</span></li>
</ul>
<p>These allow us to have the model look back at the sales in the near past, possibly strengthening the prediction.</p>
<p>The original dataset on <a href="https://www.kaggle.com/c/rossmann-store-sales">Kaggle.com</a> included both training and testing data, but since the official competition ended a decade ago, the actual true testing outcomes <span class="math inline">\(\mathbf{y}\)</span> <span class="math inline">\((Sales)\)</span> are not available. For this reason, we split the data ourselves, with the test data having approximately 6 weeks (consistent with the length of the original competition’s test period).</p>
<div id="cb7f0a11" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> pd.read_pickle(<span class="st">"../train_clean.pkl"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Due to autocorrelation surfacing in the visualization part, we"re going to add </span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># lag and rolling mean</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> dataset.sort_values(by<span class="op">=</span>[<span class="st">"Store"</span>, <span class="st">"Date"</span>]).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> warnings.catch_warnings():</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    warnings.simplefilter(<span class="st">"ignore"</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    dataset[<span class="st">"SalesLag1"</span>] <span class="op">=</span> dataset.groupby(<span class="st">"Store"</span>)[<span class="st">"Sales"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    dataset[<span class="st">"SalesLag7"</span>] <span class="op">=</span> dataset.groupby(<span class="st">"Store"</span>)[<span class="st">"Sales"</span>].shift(<span class="dv">7</span>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    dataset[<span class="st">"RollingMean7"</span>] <span class="op">=</span> dataset.groupby(<span class="st">"Store"</span>)[<span class="st">"Sales"</span>].rolling(<span class="dv">7</span>).mean().shift(<span class="dv">1</span>).reset_index(level<span class="op">=</span><span class="dv">0</span>, drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    first_idx_per_store <span class="op">=</span> dataset.groupby(<span class="st">"Store"</span>).head(<span class="dv">1</span>).index</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    dataset.loc[first_idx_per_store, <span class="st">"RollingMean7"</span>] <span class="op">=</span> <span class="bu">float</span>(<span class="st">"nan"</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    dataset[<span class="st">"SalesLag1Available"</span>] <span class="op">=</span> <span class="op">~</span>dataset[<span class="st">"SalesLag1"</span>].isna() <span class="op">*</span> <span class="dv">1</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    dataset[<span class="st">"SalesLag7Available"</span>] <span class="op">=</span> <span class="op">~</span>dataset[<span class="st">"SalesLag7"</span>].isna() <span class="op">*</span> <span class="dv">1</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    dataset[<span class="st">"RollingMean7Available"</span>] <span class="op">=</span> <span class="op">~</span>dataset[<span class="st">"RollingMean7"</span>].isna() <span class="op">*</span> <span class="dv">1</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    dataset.loc[:, dataset.isna().<span class="bu">sum</span>() <span class="op">!=</span> <span class="dv">0</span>] <span class="op">=</span> dataset.loc[:, dataset.isna().<span class="bu">sum</span>() <span class="op">!=</span> <span class="dv">0</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">### Split the dataset into 3 disjunct sets</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    days_amount <span class="op">=</span> (dataset.Date.iloc[<span class="op">-</span><span class="dv">1</span>,] <span class="op">-</span> dataset.Date.iloc[<span class="dv">0</span>,])</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"The entire dataset is"</span>, days_amount.days, <span class="st">"days long"</span>)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We will do 90-5-5 split to align with the original kaggle prediction expectations</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Gets the last date information and goes back around 5% of the dataset (the -1 corrects from sunday to monday)</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    test_split_time <span class="op">=</span> dataset.Date.iloc[<span class="op">-</span><span class="dv">1</span>,] <span class="op">-</span> pd.Timedelta(days<span class="op">=</span><span class="bu">int</span>(days_amount.days<span class="op">*</span><span class="fl">0.05</span> <span class="op">-</span> <span class="dv">1</span>))</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Same for the validation data</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>    validation_split_time <span class="op">=</span> dataset.Date.iloc[<span class="op">-</span><span class="dv">1</span>,] <span class="op">-</span> pd.Timedelta(days<span class="op">=</span><span class="bu">int</span>(days_amount.days<span class="op">*</span><span class="fl">0.1</span> <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>    train_set <span class="op">=</span> dataset[dataset.Date <span class="op">&lt;</span> validation_split_time]</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    validation_set <span class="op">=</span> dataset[(dataset.Date <span class="op">&gt;=</span> validation_split_time) <span class="op">&amp;</span> (dataset.Date <span class="op">&lt;</span> test_split_time)]</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>    test_set <span class="op">=</span> dataset[dataset.Date <span class="op">&gt;=</span> test_split_time]</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    newly_created_sets <span class="op">=</span> ((train_set, <span class="st">"training set"</span>), (validation_set, <span class="st">"validation set"</span>), (test_set, <span class="st">"testing set"</span>))</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if the division went well</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> data_partition, name <span class="kw">in</span> newly_created_sets:</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>        display(data_partition.Date.iloc[[<span class="op">-</span><span class="dv">1</span>,<span class="dv">0</span>],])</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"The </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> makes up </span><span class="sc">{</span>data_partition<span class="sc">.</span>shape[<span class="dv">0</span>] <span class="op">*</span> <span class="dv">100</span> <span class="op">/</span> dataset<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:.2f}</span><span class="ss"> % of the dataset"</span>)</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>    holiday_map <span class="op">=</span> {<span class="st">"0"</span>: <span class="dv">0</span>, <span class="st">"a"</span>: <span class="dv">1</span>, <span class="st">"b"</span>: <span class="dv">2</span>, <span class="st">"c"</span>: <span class="dv">3</span>}</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>    storetype_map <span class="op">=</span> {<span class="st">"a"</span>: <span class="dv">0</span>, <span class="st">"b"</span>: <span class="dv">1</span>, <span class="st">"c"</span>: <span class="dv">2</span>, <span class="st">"d"</span>: <span class="dv">3</span>}</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>    assortment_map <span class="op">=</span> {<span class="st">"a"</span>: <span class="dv">0</span>, <span class="st">"b"</span>: <span class="dv">1</span>, <span class="st">"c"</span>: <span class="dv">2</span>}</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> warnings.catch_warnings():</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>        warnings.simplefilter(<span class="st">"ignore"</span>)</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> df <span class="kw">in</span> (train_set, validation_set, test_set):</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">"StateHoliday"</span>] <span class="op">=</span> df[<span class="st">"StateHoliday"</span>].<span class="bu">map</span>(holiday_map).astype(<span class="bu">int</span>)</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">"StoreType"</span>] <span class="op">=</span> df[<span class="st">"StoreType"</span>].<span class="bu">map</span>(storetype_map).astype(<span class="bu">int</span>)</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">"Assortment"</span>] <span class="op">=</span> df[<span class="st">"Assortment"</span>].<span class="bu">map</span>(assortment_map).astype(<span class="bu">int</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>The entire dataset is 941 days long</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>1017112   2015-04-26
0         2013-01-01
Name: Date, dtype: datetime64[ns]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>The training set makes up 89.48 % of the dataset</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>1017161   2015-06-14
846       2015-04-27
Name: Date, dtype: datetime64[ns]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>The validation set makes up 5.37 % of the dataset</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>1017208   2015-07-31
895       2015-06-15
Name: Date, dtype: datetime64[ns]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>The testing set makes up 5.15 % of the dataset</code></pre>
</div>
</div>
<div id="317c93ec" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>train_set_open <span class="op">=</span> train_set.loc[train_set.Open <span class="op">==</span> <span class="dv">1</span>, :]</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>validation_set_open <span class="op">=</span> validation_set.loc[validation_set.Open <span class="op">==</span> <span class="dv">1</span>, :]</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>test_set_open <span class="op">=</span> test_set.loc[test_set.Open <span class="op">==</span> <span class="dv">1</span>, :]</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rmspe(y_true, y_pred):</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    y_true <span class="op">=</span> np.array(y_true)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> np.array(y_pred)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    non_zero_idx <span class="op">=</span> y_true <span class="op">!=</span> <span class="dv">0</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.sqrt(np.mean(((y_true[non_zero_idx] <span class="op">-</span> y_pred[non_zero_idx]) <span class="op">/</span> y_true[non_zero_idx])<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>dataset.loc[dataset.Store <span class="op">==</span> <span class="dv">1</span>, :].head(<span class="dv">5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Sales</th>
<th data-quarto-table-cell-role="th">Customers</th>
<th data-quarto-table-cell-role="th">Store</th>
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">DayOfWeek</th>
<th data-quarto-table-cell-role="th">Week</th>
<th data-quarto-table-cell-role="th">Month</th>
<th data-quarto-table-cell-role="th">Year</th>
<th data-quarto-table-cell-role="th">Open</th>
<th data-quarto-table-cell-role="th">Promo</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">CompetitionMonthsTotal</th>
<th data-quarto-table-cell-role="th">Promo2</th>
<th data-quarto-table-cell-role="th">Promo2MonthsTotal</th>
<th data-quarto-table-cell-role="th">Promo2CurrentlyOn</th>
<th data-quarto-table-cell-role="th">SalesLag1</th>
<th data-quarto-table-cell-role="th">SalesLag7</th>
<th data-quarto-table-cell-role="th">RollingMean7</th>
<th data-quarto-table-cell-role="th">SalesLag1Available</th>
<th data-quarto-table-cell-role="th">SalesLag7Available</th>
<th data-quarto-table-cell-role="th">RollingMean7Available</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>0</td>
<td>0</td>
<td>1</td>
<td>2013-01-01</td>
<td>2</td>
<td>1</td>
<td>1</td>
<td>2013</td>
<td>0</td>
<td>0</td>
<td>...</td>
<td>52</td>
<td>0</td>
<td>0.0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>5530</td>
<td>668</td>
<td>1</td>
<td>2013-01-02</td>
<td>3</td>
<td>1</td>
<td>1</td>
<td>2013</td>
<td>1</td>
<td>0</td>
<td>...</td>
<td>52</td>
<td>0</td>
<td>0.0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>4327</td>
<td>578</td>
<td>1</td>
<td>2013-01-03</td>
<td>4</td>
<td>1</td>
<td>1</td>
<td>2013</td>
<td>1</td>
<td>0</td>
<td>...</td>
<td>52</td>
<td>0</td>
<td>0.0</td>
<td>0</td>
<td>5530.0</td>
<td>0.0</td>
<td>0.0</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>4486</td>
<td>619</td>
<td>1</td>
<td>2013-01-04</td>
<td>5</td>
<td>1</td>
<td>1</td>
<td>2013</td>
<td>1</td>
<td>0</td>
<td>...</td>
<td>52</td>
<td>0</td>
<td>0.0</td>
<td>0</td>
<td>4327.0</td>
<td>0.0</td>
<td>0.0</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>4997</td>
<td>635</td>
<td>1</td>
<td>2013-01-05</td>
<td>6</td>
<td>1</td>
<td>1</td>
<td>2013</td>
<td>1</td>
<td>0</td>
<td>...</td>
<td>52</td>
<td>0</td>
<td>0.0</td>
<td>0</td>
<td>4486.0</td>
<td>0.0</td>
<td>0.0</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>

<p>5 rows × 26 columns</p>
</div>
</div>
</div>
</section>
<section id="modeling-approach" class="level3">
<h3 class="anchored" data-anchor-id="modeling-approach">3.1.2 Modeling Approach</h3>
<p>The true testing set is missing not only the target <span class="math inline">\(Sales\)</span> but also the customer count. One option would be to model <span class="math inline">\(Sales\)</span> directly and let the model accurately predict customer effect. In our approach however, we model the customers individually first, and only after getting the customers values, predict the true sales with a <span class="math inline">\(Sales\)</span> model that utilizes customer count.</p>
<div id="fig-model-flowchart" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-model-flowchart-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart TB
    T(Test set)

    subgraph CUSTOMERS[Customer Part]
    A(Fit a customers only model) 
    D(Validation set)
    D -.-&gt; |validate|A
    A -.-&gt; |train|D(Validation set)
    A --&gt; E([Model selected])
    end

    subgraph SALES[Sales Part]
    B("Fit a sales model")
    DD -.-&gt; |validate|B
    B -.-&gt; |train|DD(Validation set)
    B --&gt; G([Model selected])
    E --&gt; |Add the customers to the test set| T
    end
    G --&gt; |"Predict the sales"| I
    T --&gt; I([Sales RMSPE])
    E --&gt; |Predict the customers| H([Customers RMSPE])
    T --&gt; H

    style G fill:#228C8D
    style E fill:#228C8D
    style A fill:#33628D,color:#FFF 
    style B fill:#33628D,color:#FFF
    style I fill:#31B57B
    style H fill:#31B57B
    style DD fill:#f1f2f6,stroke-dasharray: 10 5,stroke:#1b2026
    style D fill:#f1f2f6,stroke-dasharray: 10 5,stroke:#1b2026
    style T fill:#f1f2f6,stroke-dasharray: 10 5,stroke:#1b2026
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-model-flowchart-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Basic flowchart of the modeling process
</figcaption>
</figure>
</div>
<p>Next, we need to incorporate the lag features. The main problem is that these values are not known in advance, so the <span class="math inline">\(Sales\)</span> model cannot be applied on the entire dataset at once.</p>
<p>To solve this issue, we can use the <span class="math inline">\(Sales\)</span> model recursively, adding a single observation of sales and updating the lag features and rolling averages accordingly.</p>
<p>The main problems:</p>
<ul>
<li>Modeling sales based on predicted values (<span class="math inline">\(Customers\)</span>)</li>
<li>Recursive modeling using lags and rolling mean - propagating the error and compounding innacuracies.</li>
</ul>
</section>
</section>
<section id="random-forests" class="level2">
<h2 class="anchored" data-anchor-id="random-forests">3.2 Random Forests</h2>
<div id="fig-static-image" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-static-image-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/tikz_bagging.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-static-image-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Schema of bootstrap aggregating
</figcaption>
</figure>
</div>
<section id="naive-modeling" class="level3">
<h3 class="anchored" data-anchor-id="naive-modeling">3.2.1 Naive Modeling</h3>
<p>We can try and compare the naive approach (modeling the <span class="math inline">\(Sales\)</span> without the customers) and the customers + recursion approach.</p>
<div id="c700e688" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>ignore_cols <span class="op">=</span> [<span class="st">"Sales"</span>, <span class="st">"Customers"</span>, <span class="st">"Date"</span>] </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>lag_cols <span class="op">=</span> [<span class="st">"SalesLag1"</span>, <span class="st">"SalesLag7"</span>, <span class="st">"RollingMean7"</span>, <span class="st">"SalesLag1Available"</span>, <span class="st">"SalesLag7Available"</span>, <span class="st">"RollingMean7Available"</span>]</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>cols_to_select <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> train_set_open.columns <span class="cf">if</span> col <span class="kw">not</span> <span class="kw">in</span> ignore_cols <span class="kw">and</span> col <span class="kw">not</span> <span class="kw">in</span> lag_cols]</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>x_train_naive <span class="op">=</span> train_set_open.loc[:, cols_to_select]</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>y_train_naive <span class="op">=</span> train_set_open.loc[:, <span class="st">"Sales"</span>]</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>x_val_naive <span class="op">=</span> validation_set_open.loc[:, cols_to_select]</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>y_val_naive <span class="op">=</span> validation_set_open.loc[:, <span class="st">"Sales"</span>]</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> grid_search(param_grid, model_type, x_train, y_train, x_val, y_val, n_jobs, verbose <span class="op">=</span> <span class="va">False</span>):</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    keys, values <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>param_grid.items())</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    param_combinations <span class="op">=</span> [<span class="bu">dict</span>(<span class="bu">zip</span>(keys, v)) <span class="cf">for</span> v <span class="kw">in</span> itertools.product(<span class="op">*</span>values)]</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    results_data <span class="op">=</span> []</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, params <span class="kw">in</span> <span class="bu">enumerate</span>(param_combinations):</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> model_type(</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>            <span class="op">**</span>params,</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>            random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>            n_jobs<span class="op">=</span>n_jobs,</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>            verbose<span class="op">=</span><span class="dv">0</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>        model.fit(x_train, y_train)</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>        y_train_predicted <span class="op">=</span> model.predict(x_train)</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>        y_val_predicted <span class="op">=</span> model.predict(x_val)</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>        mse_train <span class="op">=</span> mean_squared_error(y_train, y_train_predicted)</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>        rmse_train <span class="op">=</span> mse_train <span class="op">**</span> <span class="fl">0.5</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>        r2_train <span class="op">=</span> r2_score(y_train, y_train_predicted)</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>        rmspe_train <span class="op">=</span> rmspe(y_train, y_train_predicted)</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>        mse_val <span class="op">=</span> mean_squared_error(y_val, y_val_predicted)</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>        rmse_val <span class="op">=</span> mse_val <span class="op">**</span> <span class="fl">0.5</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>        r2_val <span class="op">=</span> r2_score(y_val, y_val_predicted)</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>        rmspe_val <span class="op">=</span> rmspe(y_val, y_val_predicted)</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>        results_entry <span class="op">=</span> params.copy()</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>        results_entry[<span class="st">"Train_RMSPE"</span>] <span class="op">=</span> rmspe_train</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>        results_entry[<span class="st">"Val_RMSPE"</span>] <span class="op">=</span> rmspe_val</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>        results_data.append(results_entry)</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> verbose:</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"==== TRAINING ==== (</span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(param_combinations)<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Train RMSE: </span><span class="sc">{</span>rmse_train<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Train R²: </span><span class="sc">{</span>r2_train<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Train RMSPE: </span><span class="sc">{</span>rmspe_train<span class="sc">:.4f}</span><span class="ss"> (</span><span class="sc">{</span>rmspe_train<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"==== TRAINING ===="</span>)</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>()</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"==== VALIDATION ==== (</span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(param_combinations)<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Validation RMSE: </span><span class="sc">{</span>rmse_val<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Validation R²: </span><span class="sc">{</span>r2_val<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Validation RMSPE: </span><span class="sc">{</span>rmspe_val<span class="sc">:.4f}</span><span class="ss"> (</span><span class="sc">{</span>rmspe_val<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"==== VALIDATION ===="</span>)</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"(</span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(param_combinations)<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>    results_df <span class="op">=</span> pd.DataFrame(results_data)</span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>    results_df <span class="op">=</span> results_df.sort_values(by<span class="op">=</span><span class="st">"Val_RMSPE"</span>, ascending<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> verbose:</span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>        display(results_df.head(<span class="dv">5</span>))</span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results_df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>For tuning hyperparameters we will utilize a simple grid-search approach, comparing the training and validation RMSPE errors and selecting the ideal model with the smallest ones.</p>
<div id="f2ff2b6c" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>param_grid_naive <span class="op">=</span> {</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_estimators"</span>: [<span class="dv">100</span>, <span class="dv">200</span>],</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"max_depth"</span>: [<span class="dv">50</span>, <span class="va">None</span>],</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"max_samples"</span>: [<span class="fl">0.6</span>, <span class="fl">0.8</span>, <span class="dv">1</span>],</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"max_features"</span>: [<span class="fl">0.5</span>, <span class="st">"sqrt"</span>, <span class="dv">1</span>]</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">#"min_samples_split": [2, 5, 10],</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">#"min_samples_leaf": [1, 2, 4]</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co"># These models do NOT use the customers to predict the sales</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>results_naive <span class="op">=</span> grid_search(param_grid<span class="op">=</span>param_grid_naive,</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>                            model_type<span class="op">=</span>RandomForestRegressor,</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>                            x_train<span class="op">=</span>x_train_naive,</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>                            y_train<span class="op">=</span>y_train_naive,</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>                            x_val<span class="op">=</span>x_val_naive,</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>                            y_val<span class="op">=</span>y_val_naive,</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>                            n_jobs<span class="op">=</span><span class="dv">5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Best performing models with these parameter combinations:</p>
<div id="92e8d046" class="cell" data-execution_count="6">
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">n_estimators</th>
<th data-quarto-table-cell-role="th">max_depth</th>
<th data-quarto-table-cell-role="th">max_samples</th>
<th data-quarto-table-cell-role="th">max_features</th>
<th data-quarto-table-cell-role="th">Train_RMSPE</th>
<th data-quarto-table-cell-role="th">Val_RMSPE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>200</td>
<td>50.0</td>
<td>0.8</td>
<td>0.5</td>
<td>0.100766</td>
<td>0.143137</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>200</td>
<td>NaN</td>
<td>0.8</td>
<td>0.5</td>
<td>0.100766</td>
<td>0.143162</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>100</td>
<td>NaN</td>
<td>0.8</td>
<td>0.5</td>
<td>0.099735</td>
<td>0.143803</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>100</td>
<td>50.0</td>
<td>0.8</td>
<td>0.5</td>
<td>0.099737</td>
<td>0.143806</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>And the worst ones:</p>
<div id="11373cf4" class="cell" data-execution_count="7">
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">n_estimators</th>
<th data-quarto-table-cell-role="th">max_depth</th>
<th data-quarto-table-cell-role="th">max_samples</th>
<th data-quarto-table-cell-role="th">max_features</th>
<th data-quarto-table-cell-role="th">Train_RMSPE</th>
<th data-quarto-table-cell-role="th">Val_RMSPE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">32</th>
<td>100</td>
<td>NaN</td>
<td>1.0</td>
<td>sqrt</td>
<td>0.660058</td>
<td>0.526316</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">33</th>
<td>100</td>
<td>NaN</td>
<td>1.0</td>
<td>1</td>
<td>0.660058</td>
<td>0.526316</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">34</th>
<td>100</td>
<td>50.0</td>
<td>1.0</td>
<td>1</td>
<td>0.660058</td>
<td>0.526316</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">35</th>
<td>100</td>
<td>NaN</td>
<td>1.0</td>
<td>0.5</td>
<td>0.660058</td>
<td>0.526316</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="recursive-modeling" class="level3">
<h3 class="anchored" data-anchor-id="recursive-modeling">3.2.2 Recursive Modeling</h3>
<div id="caa614e2" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>cust_ignore_cols <span class="op">=</span> [<span class="st">"Sales"</span>, <span class="st">"Customers"</span>, <span class="st">"Date"</span>]</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>sales_ignore_cols <span class="op">=</span> [<span class="st">"Sales"</span>, <span class="st">"Date"</span>]</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>lag_cols <span class="op">=</span> [<span class="st">"SalesLag1"</span>, <span class="st">"SalesLag7"</span>, <span class="st">"RollingMean7"</span>, <span class="st">"SalesLag1Available"</span>, <span class="st">"SalesLag7Available"</span>, <span class="st">"RollingMean7Available"</span>]</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>cols_to_select_cust <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> train_set_open.columns <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> cust_ignore_cols <span class="kw">and</span> c <span class="kw">not</span> <span class="kw">in</span> lag_cols]</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>cols_to_select_sales <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> train_set_open.columns <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> sales_ignore_cols]</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>x_train_cust <span class="op">=</span> train_set_open[cols_to_select_cust]</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>y_train_cust <span class="op">=</span> train_set_open.loc[:, <span class="st">"Customers"</span>]</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>x_val_cust <span class="op">=</span> validation_set_open[cols_to_select_cust]</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>y_val_cust <span class="op">=</span> validation_set_open.loc[:, <span class="st">"Customers"</span>]</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>x_train_sales <span class="op">=</span> train_set_open[cols_to_select_sales]</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>y_train_sales <span class="op">=</span> train_set_open.loc[:, <span class="st">"Sales"</span>]</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>x_val_sales <span class="op">=</span> validation_set_open[cols_to_select_sales]</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>y_val_sales <span class="op">=</span> validation_set_open.loc[:, <span class="st">"Sales"</span>]</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>param_grid_cust <span class="op">=</span> {</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_estimators"</span>: [<span class="dv">50</span>, <span class="dv">100</span>],</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"max_depth"</span>: [<span class="dv">10</span>, <span class="dv">25</span>, <span class="dv">50</span>],</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"max_samples"</span>: [<span class="fl">0.6</span>, <span class="fl">0.8</span>],</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"max_features"</span>: [<span class="fl">0.5</span>, <span class="st">"sqrt"</span>]</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>results_cust <span class="op">=</span> grid_search(param_grid<span class="op">=</span>param_grid_cust,</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>                           model_type<span class="op">=</span>RandomForestRegressor,</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>                           x_train<span class="op">=</span>x_train_cust,</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>                           y_train<span class="op">=</span>y_train_cust,</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>                           x_val<span class="op">=</span>x_val_cust,</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>                           y_val<span class="op">=</span>y_val_cust,</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>                           n_jobs<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>param_grid_sales <span class="op">=</span> {</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_estimators"</span>: [<span class="dv">50</span>, <span class="dv">100</span>],</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"max_depth"</span>: [<span class="dv">10</span>, <span class="dv">25</span>, <span class="dv">50</span>],</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">"max_samples"</span>: [<span class="fl">0.6</span>, <span class="fl">0.8</span>],</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">"max_features"</span>: [<span class="fl">0.5</span>, <span class="st">"sqrt"</span>]</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>results_sales <span class="op">=</span> grid_search(param_grid<span class="op">=</span>param_grid_sales,</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>                            model_type<span class="op">=</span>RandomForestRegressor,</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>                            x_train<span class="op">=</span>x_train_sales,</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>                            y_train<span class="op">=</span>y_train_sales,</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>                            x_val<span class="op">=</span>x_val_sales,</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>                            y_val<span class="op">=</span>y_val_sales,</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>                            n_jobs<span class="op">=</span><span class="dv">5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>For the resursive modeling, we need to optimize the hyperparameters of two distinct models. The first one being the classic <span class="math inline">\(Customers\)</span> model:</p>
<div id="885e5068" class="cell" data-execution_count="10">
<div class="cell-output cell-output-display">
<style type="text/css">
#T_d6111_row0_col0, #T_d6111_row0_col1, #T_d6111_row0_col2, #T_d6111_row0_col3, #T_d6111_row0_col4, #T_d6111_row0_col5 {
  background-color: #32648e;
  font-weight: bold;
  color: white;
}
#T_d6111_row1_col0, #T_d6111_row1_col1, #T_d6111_row1_col2, #T_d6111_row1_col3, #T_d6111_row1_col4, #T_d6111_row1_col5 {
  background-color: #21918c;
  font-weight: bold;
  color: white;
}
</style>

<table id="T_d6111" class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th class="blank level0" data-quarto-table-cell-role="th">&nbsp;</th>
<th id="T_d6111_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">n_estimators</th>
<th id="T_d6111_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">max_depth</th>
<th id="T_d6111_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">max_samples</th>
<th id="T_d6111_level0_col3" class="col_heading level0 col3" data-quarto-table-cell-role="th">max_features</th>
<th id="T_d6111_level0_col4" class="col_heading level0 col4" data-quarto-table-cell-role="th">Train_RMSPE</th>
<th id="T_d6111_level0_col5" class="col_heading level0 col5" data-quarto-table-cell-role="th">Val_RMSPE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th id="T_d6111_level0_row0" class="row_heading level0 row0" data-quarto-table-cell-role="th">0</th>
<td id="T_d6111_row0_col0" class="data row0 col0">100</td>
<td id="T_d6111_row0_col1" class="data row0 col1">25</td>
<td id="T_d6111_row0_col2" class="data row0 col2">0.800000</td>
<td id="T_d6111_row0_col3" class="data row0 col3">0.5</td>
<td id="T_d6111_row0_col4" class="data row0 col4">0.270484</td>
<td id="T_d6111_row0_col5" class="data row0 col5">0.111431</td>
</tr>
<tr class="even">
<th id="T_d6111_level0_row1" class="row_heading level0 row1" data-quarto-table-cell-role="th">1</th>
<td id="T_d6111_row1_col0" class="data row1 col0">100</td>
<td id="T_d6111_row1_col1" class="data row1 col1">50</td>
<td id="T_d6111_row1_col2" class="data row1 col2">0.600000</td>
<td id="T_d6111_row1_col3" class="data row1 col3">0.5</td>
<td id="T_d6111_row1_col4" class="data row1 col4">0.309755</td>
<td id="T_d6111_row1_col5" class="data row1 col5">0.111556</td>
</tr>
<tr class="odd">
<th id="T_d6111_level0_row2" class="row_heading level0 row2" data-quarto-table-cell-role="th">2</th>
<td id="T_d6111_row2_col0" class="data row2 col0">50</td>
<td id="T_d6111_row2_col1" class="data row2 col1">25</td>
<td id="T_d6111_row2_col2" class="data row2 col2">0.800000</td>
<td id="T_d6111_row2_col3" class="data row2 col3">0.5</td>
<td id="T_d6111_row2_col4" class="data row2 col4">0.268149</td>
<td id="T_d6111_row2_col5" class="data row2 col5">0.112639</td>
</tr>
<tr class="even">
<th id="T_d6111_level0_row3" class="row_heading level0 row3" data-quarto-table-cell-role="th">3</th>
<td id="T_d6111_row3_col0" class="data row3 col0">100</td>
<td id="T_d6111_row3_col1" class="data row3 col1">50</td>
<td id="T_d6111_row3_col2" class="data row3 col2">0.800000</td>
<td id="T_d6111_row3_col3" class="data row3 col3">0.5</td>
<td id="T_d6111_row3_col4" class="data row3 col4">0.260749</td>
<td id="T_d6111_row3_col5" class="data row3 col5">0.112667</td>
</tr>
</tbody>
</table>
</div>
</div>
<p><br></p>
<div style="display: flex; gap: 0; padding: 0; margin: 0;">
<p><img src="images/tree_depths_cust_rf_best.png" style="width: 49%; padding: 0; margin: 0; border: none;"> <img src="images/tree_depths_cust_rf_showcase.png" style="width: 49%; padding: 0; margin: 0; border: none;"></p>
</div>
<p>Both of the tables show a very unusual situation, where the training error is actually higher than the validation error. This can happen because the validation set is very small, so the model finds it considerably easier to predict values there, compared to the training set with full yearly seasonality.</p>
<div id="76254954" class="cell" data-execution_count="11">
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">n_estimators</th>
<th data-quarto-table-cell-role="th">max_depth</th>
<th data-quarto-table-cell-role="th">max_samples</th>
<th data-quarto-table-cell-role="th">max_features</th>
<th data-quarto-table-cell-role="th">Train_RMSPE</th>
<th data-quarto-table-cell-role="th">Val_RMSPE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">20</th>
<td>100</td>
<td>10</td>
<td>0.8</td>
<td>sqrt</td>
<td>0.636570</td>
<td>0.364999</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">21</th>
<td>50</td>
<td>10</td>
<td>0.8</td>
<td>sqrt</td>
<td>0.631616</td>
<td>0.365386</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">22</th>
<td>50</td>
<td>10</td>
<td>0.6</td>
<td>sqrt</td>
<td>0.626613</td>
<td>0.366301</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">23</th>
<td>100</td>
<td>10</td>
<td>0.6</td>
<td>sqrt</td>
<td>0.632858</td>
<td>0.367326</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="fig-static-image2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-static-image2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/cust_rf_tree.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-static-image2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: A small slice of the first tree in the forest
</figcaption>
</figure>
</div>
<p><br></p>
<p>The second model is the recursive <span class="math inline">\(Sales\)</span> one. This setup does <em>not</em> change how the model is trained, since the training dataset includes the actual customers and lags. The fitted model processes the data row by row, allowing it to be used in any way that we deem fit.</p>
<div id="a2953df0" class="cell" data-execution_count="12">
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">n_estimators</th>
<th data-quarto-table-cell-role="th">max_depth</th>
<th data-quarto-table-cell-role="th">max_samples</th>
<th data-quarto-table-cell-role="th">max_features</th>
<th data-quarto-table-cell-role="th">Train_RMSPE</th>
<th data-quarto-table-cell-role="th">Val_RMSPE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>100</td>
<td>25</td>
<td>0.8</td>
<td>0.5</td>
<td>0.045328</td>
<td>0.091265</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>100</td>
<td>50</td>
<td>0.8</td>
<td>0.5</td>
<td>0.042400</td>
<td>0.091336</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>50</td>
<td>25</td>
<td>0.8</td>
<td>0.5</td>
<td>0.044859</td>
<td>0.092082</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>50</td>
<td>50</td>
<td>0.8</td>
<td>0.5</td>
<td>0.042062</td>
<td>0.092088</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>It is important to note the gap between the best naive error <span class="math inline">\(\text{RMSPE}_{naive}^{val} = 0.1431\)</span> and the performance of the model which incorporates customers and time variables, with <span class="math inline">\(\text{RMSPE}_{recur}^{val} = 0.0913\)</span>.</p>
<p>The final models used for the modeling have these hyperparameters (we chose the 3rd sales model from the table, as it was less memory-heavy):</p>
<div id="0bf63aba" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> recursive_predict_sales_only(model_sales, train_data, test_data, sales_feats):</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    working_df <span class="op">=</span> test_data.copy().sort_values([<span class="st">"Date"</span>, <span class="st">"Store"</span>])</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Setup History</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    req_cols <span class="op">=</span> <span class="bu">list</span>(<span class="bu">set</span>(sales_feats <span class="op">+</span> [<span class="st">"Store"</span>, <span class="st">"Date"</span>, <span class="st">"Sales"</span>]))</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    history <span class="op">=</span> train_data[req_cols].copy()</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    history <span class="op">=</span> history.sort_values([<span class="st">"Store"</span>, <span class="st">"Date"</span>])</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    unique_dates <span class="op">=</span> working_df[<span class="st">"Date"</span>].unique()</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    unique_dates <span class="op">=</span> np.sort(unique_dates)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    final_predictions <span class="op">=</span> []</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> current_date <span class="kw">in</span> unique_dates:</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>        todays_slice <span class="op">=</span> working_df[working_df[<span class="st">"Date"</span>] <span class="op">==</span> current_date].copy()</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>        active_stores <span class="op">=</span> todays_slice[<span class="st">"Store"</span>].unique()</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>        recent_history <span class="op">=</span> history[</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>            (history[<span class="st">"Store"</span>].isin(active_stores)) <span class="op">&amp;</span> </span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>            (history[<span class="st">"Date"</span>] <span class="op">&gt;=</span> current_date <span class="op">-</span> pd.Timedelta(days<span class="op">=</span><span class="dv">8</span>)) <span class="op">&amp;</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>            (history[<span class="st">"Date"</span>] <span class="op">&lt;</span> current_date)</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>        calc_df <span class="op">=</span> pd.concat([recent_history, todays_slice], axis<span class="op">=</span><span class="dv">0</span>, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>        calc_df <span class="op">=</span> calc_df.sort_values([<span class="st">"Store"</span>, <span class="st">"Date"</span>])</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>        calc_df[<span class="st">"SalesLag1"</span>] <span class="op">=</span> calc_df.groupby(<span class="st">"Store"</span>)[<span class="st">"Sales"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>        calc_df[<span class="st">"SalesLag7"</span>] <span class="op">=</span> calc_df.groupby(<span class="st">"Store"</span>)[<span class="st">"Sales"</span>].shift(<span class="dv">7</span>)</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>        calc_df[<span class="st">"RollingMean7"</span>] <span class="op">=</span> calc_df.groupby(<span class="st">"Store"</span>)[<span class="st">"Sales"</span>].rolling(<span class="dv">7</span>).mean().shift(<span class="dv">1</span>).reset_index(level<span class="op">=</span><span class="dv">0</span>, drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>        X_today <span class="op">=</span> calc_df[calc_df[<span class="st">"Date"</span>] <span class="op">==</span> current_date].copy()</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>        X_today[<span class="st">"SalesLag1Available"</span>] <span class="op">=</span> <span class="op">~</span>X_today[<span class="st">"SalesLag1"</span>].isna() <span class="op">*</span> <span class="dv">1</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>        X_today[<span class="st">"SalesLag7Available"</span>] <span class="op">=</span> <span class="op">~</span>X_today[<span class="st">"SalesLag7"</span>].isna() <span class="op">*</span> <span class="dv">1</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>        X_today[<span class="st">"RollingMean7Available"</span>] <span class="op">=</span> <span class="op">~</span>X_today[<span class="st">"RollingMean7"</span>].isna() <span class="op">*</span> <span class="dv">1</span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>        X_today <span class="op">=</span> X_today.fillna(<span class="dv">0</span>)</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># calculate todays values</span></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>        X_today_feats <span class="op">=</span> X_today[sales_feats]</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>        sales_preds <span class="op">=</span> model_sales.predict(X_today_feats)</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">"Open"</span> <span class="kw">in</span> X_today.columns:</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>            sales_preds[X_today[<span class="st">"Open"</span>] <span class="op">==</span> <span class="dv">0</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>        <span class="co"># update</span></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>        X_today_result <span class="op">=</span> X_today.copy()</span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>        X_today_result[<span class="st">"Sales"</span>] <span class="op">=</span> sales_preds</span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>        update_packet <span class="op">=</span> X_today_result[req_cols]</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>        history <span class="op">=</span> pd.concat([history, update_packet], axis<span class="op">=</span><span class="dv">0</span>, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>        final_predictions.append(X_today_result[[<span class="st">"Store"</span>, <span class="st">"Date"</span>, <span class="st">"Sales"</span>]])</span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>    final_df <span class="op">=</span> pd.concat(final_predictions, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> final_df</span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>recursive_train_set <span class="op">=</span> train_set.copy()</span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a>recursive_validation_set <span class="op">=</span> validation_set.copy()</span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a>recursive_training_df <span class="op">=</span> pd.concat([recursive_train_set, </span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a>                                   recursive_validation_set], axis <span class="op">=</span> <span class="dv">0</span>).sort_values([<span class="st">"Store"</span>, <span class="st">"Date"</span>])</span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a>recursive_test_df <span class="op">=</span> test_set.copy().sort_values([<span class="st">"Store"</span>, <span class="st">"Date"</span>])</span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a><span class="co"># This gets the best parameters based on the naive grid search for customers only</span></span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a>model_cust <span class="op">=</span> RandomForestRegressor(<span class="op">**</span>customers_best_params_rf, </span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a>                                   n_jobs<span class="op">=</span><span class="dv">4</span>, </span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a>                                   random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a>                                   verbose<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a>model_cust.fit(recursive_training_df.loc[recursive_training_df[<span class="st">"Open"</span>] <span class="op">==</span> <span class="dv">1</span>, cols_to_select_cust], </span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a>               recursive_training_df.loc[recursive_training_df[<span class="st">"Open"</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">"Customers"</span>])</span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a>gc.collect()</span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true" tabindex="-1"></a><span class="co"># This gets the best parameters with actual sales values</span></span>
<span id="cb13-79"><a href="#cb13-79" aria-hidden="true" tabindex="-1"></a>model_sales <span class="op">=</span> RandomForestRegressor(<span class="op">**</span>sales_best_params_rf, </span>
<span id="cb13-80"><a href="#cb13-80" aria-hidden="true" tabindex="-1"></a>                                    n_jobs<span class="op">=</span><span class="dv">4</span>, </span>
<span id="cb13-81"><a href="#cb13-81" aria-hidden="true" tabindex="-1"></a>                                    random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb13-82"><a href="#cb13-82" aria-hidden="true" tabindex="-1"></a>                                    verbose<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb13-83"><a href="#cb13-83" aria-hidden="true" tabindex="-1"></a>model_sales.fit(recursive_training_df.loc[recursive_training_df[<span class="st">"Open"</span>] <span class="op">==</span> <span class="dv">1</span>, cols_to_select_sales], </span>
<span id="cb13-84"><a href="#cb13-84" aria-hidden="true" tabindex="-1"></a>                recursive_training_df.loc[recursive_training_df[<span class="st">"Open"</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">"Sales"</span>])</span>
<span id="cb13-85"><a href="#cb13-85" aria-hidden="true" tabindex="-1"></a>gc.collect()</span>
<span id="cb13-86"><a href="#cb13-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-87"><a href="#cb13-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-88"><a href="#cb13-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-89"><a href="#cb13-89" aria-hidden="true" tabindex="-1"></a>test_cust_preds <span class="op">=</span> model_cust.predict(recursive_test_df.loc[recursive_test_df[<span class="st">"Open"</span>] <span class="op">==</span> <span class="dv">1</span>, cols_to_select_cust])</span>
<span id="cb13-90"><a href="#cb13-90" aria-hidden="true" tabindex="-1"></a>test_cust_rmspe_open <span class="op">=</span> rmspe(recursive_test_df.loc[recursive_test_df[<span class="st">"Open"</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">"Customers"</span>], test_cust_preds)</span>
<span id="cb13-91"><a href="#cb13-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-92"><a href="#cb13-92" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Customers only, open stores RMSPE is: </span><span class="sc">{</span>test_cust_rmspe_open<span class="sc">:.4f}</span><span class="ss">."</span>)</span>
<span id="cb13-93"><a href="#cb13-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-94"><a href="#cb13-94" aria-hidden="true" tabindex="-1"></a>recursive_test_df.loc[recursive_test_df[<span class="st">"Open"</span>] <span class="op">==</span> <span class="dv">0</span>, <span class="st">"Customers"</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb13-95"><a href="#cb13-95" aria-hidden="true" tabindex="-1"></a>recursive_test_df.loc[recursive_test_df[<span class="st">"Open"</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">"Customers"</span>] <span class="op">=</span> np.<span class="bu">round</span>(test_cust_preds)</span>
<span id="cb13-96"><a href="#cb13-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-97"><a href="#cb13-97" aria-hidden="true" tabindex="-1"></a>val_results <span class="op">=</span> recursive_predict_sales_only(</span>
<span id="cb13-98"><a href="#cb13-98" aria-hidden="true" tabindex="-1"></a>    model_sales, </span>
<span id="cb13-99"><a href="#cb13-99" aria-hidden="true" tabindex="-1"></a>    recursive_training_df,</span>
<span id="cb13-100"><a href="#cb13-100" aria-hidden="true" tabindex="-1"></a>    recursive_test_df,</span>
<span id="cb13-101"><a href="#cb13-101" aria-hidden="true" tabindex="-1"></a>    cols_to_select_sales</span>
<span id="cb13-102"><a href="#cb13-102" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-103"><a href="#cb13-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-104"><a href="#cb13-104" aria-hidden="true" tabindex="-1"></a>score <span class="op">=</span> rmspe(val_results.sort_values([<span class="st">"Store"</span>, <span class="st">"Date"</span>])[<span class="st">"Sales"</span>], recursive_test_df[<span class="st">"Sales"</span>])</span>
<span id="cb13-105"><a href="#cb13-105" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Final test sales RMSPE: </span><span class="sc">{</span>score<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="f862a75a" class="cell" data-execution_count="14">
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">n_estimators</th>
<th data-quarto-table-cell-role="th">max_depth</th>
<th data-quarto-table-cell-role="th">max_samples</th>
<th data-quarto-table-cell-role="th">max_features</th>
<th data-quarto-table-cell-role="th">Test_RMSPE</th>
<th data-quarto-table-cell-role="th">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>50</td>
<td>25</td>
<td>0.8</td>
<td>0.5</td>
<td>0.1236</td>
<td>Customers only</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>50</td>
<td>25</td>
<td>0.8</td>
<td>0.5</td>
<td>0.1406</td>
<td>Final sales</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The final model is performing decently with an error of <span class="math inline">\(\text{RMSPE}^{test}_{recur} = 0.1406\)</span>, which can be treated as a hypothetical baseline for the models that follow.</p>
</section>
</section>
<section id="gradient-boosting---lightgbm" class="level2">
<h2 class="anchored" data-anchor-id="gradient-boosting---lightgbm">3.3 Gradient Boosting - LightGBM</h2>
<p>Gradient boosting algorithms offer a modern and highly effective way to utilize decision trees in machine learning. They are significantly more lightweight compared to random forests, much faster and tend to deliver much better results compared to random forests. The most popular algorithms (for regression) are <strong>XGBoost</strong> and <strong>LightGBM</strong>.</p>
<p>We decided to use the LightGBM due to it’s higher efficiency (mainly less memory usage).</p>
<div id="ca3f8906" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>lgbm_param_grid_cust <span class="op">=</span> {</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_estimators"</span>: [<span class="dv">500</span>, <span class="dv">1000</span>],</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"learning_rate"</span>: [<span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>],</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"num_leaves"</span>: [<span class="dv">15</span>, <span class="dv">31</span>, <span class="dv">63</span>],</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"subsample"</span>: [<span class="fl">0.6</span>, <span class="fl">0.8</span>, <span class="dv">1</span>],</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"subsample_freq"</span>: [<span class="dv">1</span>],</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"colsample_bytree"</span>: [<span class="fl">0.5</span>, <span class="fl">0.8</span>, <span class="dv">1</span>]</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>results_cust_lgb <span class="op">=</span> grid_search_log(param_grid<span class="op">=</span>lgbm_param_grid_cust,</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>                                   model_type<span class="op">=</span>lgb.LGBMRegressor,</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>                                   x_train<span class="op">=</span>x_train_cust,</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>                                   y_train<span class="op">=</span>np.log1p(y_train_cust),</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>                                   x_val<span class="op">=</span>x_val_cust,</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>                                   y_val<span class="op">=</span>np.log1p(y_val_cust),</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>                                   n_jobs<span class="op">=</span><span class="dv">5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>As we have seen in the visualization part, we decided to take a <span class="math inline">\(\log{(x + 1)}\)</span> of customers and sales, which helped with their skewness and centered them.</p>
<p>The performance of the <span class="math inline">\(Customer\)</span> model on the validation set is comparable to that of the Random Forests. However, LightGBM model improved hugely on the training data, perhaps suggesting that now it would have the capacity to achieve strong results regardless of the seasonal positioning of the validation period.</p>
<div id="4fb33b08" class="cell" data-execution_count="17">
<div class="cell-output cell-output-display" data-execution_count="13">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">n_estimators</th>
<th data-quarto-table-cell-role="th">learning_rate</th>
<th data-quarto-table-cell-role="th">num_leaves</th>
<th data-quarto-table-cell-role="th">subsample</th>
<th data-quarto-table-cell-role="th">subsample_freq</th>
<th data-quarto-table-cell-role="th">colsample_bytree</th>
<th data-quarto-table-cell-role="th">Train_RMSPE</th>
<th data-quarto-table-cell-role="th">Val_RMSPE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>4000</td>
<td>0.1</td>
<td>63</td>
<td>0.8</td>
<td>1</td>
<td>1.0</td>
<td>0.205260</td>
<td>0.114333</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>5000</td>
<td>0.1</td>
<td>63</td>
<td>0.8</td>
<td>1</td>
<td>1.0</td>
<td>0.178331</td>
<td>0.114366</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>6000</td>
<td>0.1</td>
<td>63</td>
<td>0.8</td>
<td>1</td>
<td>1.0</td>
<td>0.147826</td>
<td>0.114541</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>3000</td>
<td>0.1</td>
<td>63</td>
<td>0.8</td>
<td>1</td>
<td>1.0</td>
<td>0.240378</td>
<td>0.114864</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Here are the results for the sales model, which show a significant improvement all around.</p>
<div id="e7ab5ebd" class="cell" data-execution_count="18">
<div class="cell-output cell-output-display" data-execution_count="14">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">n_estimators</th>
<th data-quarto-table-cell-role="th">learning_rate</th>
<th data-quarto-table-cell-role="th">num_leaves</th>
<th data-quarto-table-cell-role="th">subsample</th>
<th data-quarto-table-cell-role="th">subsample_freq</th>
<th data-quarto-table-cell-role="th">colsample_bytree</th>
<th data-quarto-table-cell-role="th">Train_RMSPE</th>
<th data-quarto-table-cell-role="th">Val_RMSPE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>6000</td>
<td>0.1</td>
<td>63</td>
<td>0.9</td>
<td>1</td>
<td>1.0</td>
<td>0.039350</td>
<td>0.061330</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>5000</td>
<td>0.1</td>
<td>63</td>
<td>0.9</td>
<td>1</td>
<td>1.0</td>
<td>0.041125</td>
<td>0.061497</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>4000</td>
<td>0.1</td>
<td>63</td>
<td>0.9</td>
<td>1</td>
<td>1.0</td>
<td>0.043126</td>
<td>0.061783</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>3000</td>
<td>0.1</td>
<td>63</td>
<td>0.9</td>
<td>1</td>
<td>1.0</td>
<td>0.045571</td>
<td>0.062242</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p><br></p>
<div id="fig-importance-cust" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-importance-cust-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/feature_importance_customers.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-importance-cust-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Feature importance for the customer model
</figcaption>
</figure>
</div>
<div id="fig-importance-sales" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-importance-sales-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="images/feature_importance_sales.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-importance-sales-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Feature importance for the sales model
</figcaption>
</figure>
</div>
<p>The final test results of our best models are shown below.</p>
<div id="047c96c0" class="cell" data-execution_count="19">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>customers_best_params_lgb <span class="op">=</span> pd.read_csv(<span class="st">"../outputs/customers_recursive_lightgbm_grid.csv"</span>).iloc[<span class="dv">0</span>, <span class="dv">0</span>:<span class="dv">6</span>].to_dict()</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>sales_best_params_lgb <span class="op">=</span> pd.read_csv(<span class="st">"../outputs/sales_recursive_lightgbm_grid.csv"</span>).iloc[<span class="dv">0</span>, <span class="dv">0</span>:<span class="dv">6</span>].to_dict()</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> params <span class="kw">in</span> (customers_best_params_lgb, sales_best_params_lgb):</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key <span class="kw">in</span> params.keys():</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> key <span class="kw">not</span> <span class="kw">in</span> (<span class="st">"learning_rate"</span>, <span class="st">"colsample_bytree"</span>, <span class="st">"subsample"</span>):</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>            params[key] <span class="op">=</span> <span class="bu">int</span>(params[key])</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>final_results_lgb <span class="op">=</span> {k: [customers_best_params_lgb[k], sales_best_params_lgb[k]] <span class="cf">for</span> k <span class="kw">in</span> customers_best_params_lgb}</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>final_results_lgb <span class="op">=</span> pd.DataFrame(final_results_lgb)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>final_results_lgb[<span class="st">"Test_RMSPE"</span>] <span class="op">=</span> [<span class="fl">0.1022</span>, <span class="fl">0.1235</span>]</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>final_results_lgb[<span class="st">"Description"</span>] <span class="op">=</span> [<span class="st">"Customers only"</span>, <span class="st">"Final sales"</span>]</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>display(final_results_lgb)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">n_estimators</th>
<th data-quarto-table-cell-role="th">learning_rate</th>
<th data-quarto-table-cell-role="th">num_leaves</th>
<th data-quarto-table-cell-role="th">subsample</th>
<th data-quarto-table-cell-role="th">subsample_freq</th>
<th data-quarto-table-cell-role="th">colsample_bytree</th>
<th data-quarto-table-cell-role="th">Test_RMSPE</th>
<th data-quarto-table-cell-role="th">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>4000</td>
<td>0.1</td>
<td>63</td>
<td>0.8</td>
<td>1</td>
<td>1.0</td>
<td>0.1022</td>
<td>Customers only</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>6000</td>
<td>0.1</td>
<td>63</td>
<td>0.9</td>
<td>1</td>
<td>1.0</td>
<td>0.1235</td>
<td>Final sales</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="neural-networks---classic-mlp" class="level2">
<h2 class="anchored" data-anchor-id="neural-networks---classic-mlp">3.4 Neural Networks - classic MLP</h2>
<p>Neural networks are the final type of model we applied. They differ from decision trees, be it boosting or random forests, as they usually need a GPU to be trained (compared to our previous models, which used the processor).</p>
<p>They are also very sensitive to the scale of input features. Because of this, we had to rebuild the entire dataset again, scaling the numerical variables while also one-hot encoding the categorical features.</p>
<div id="a605d00f" class="cell" data-execution_count="20">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>dataset_nn <span class="op">=</span> pd.read_pickle(<span class="st">"../train_clean.pkl"</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>dataset_nn <span class="op">=</span> dataset_nn.sort_values(by<span class="op">=</span>[<span class="st">"Store"</span>, <span class="st">"Date"</span>]).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ===== CREATING LAGS AND ROLLING MEANS =====</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> warnings.catch_warnings():</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    warnings.simplefilter(<span class="st">"ignore"</span>)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    dataset_nn[<span class="st">"SalesLag1"</span>] <span class="op">=</span> dataset_nn.groupby(<span class="st">"Store"</span>)[<span class="st">"Sales"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    dataset_nn[<span class="st">"SalesLag7"</span>] <span class="op">=</span> dataset_nn.groupby(<span class="st">"Store"</span>)[<span class="st">"Sales"</span>].shift(<span class="dv">7</span>)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    dataset_nn[<span class="st">"RollingMean7"</span>] <span class="op">=</span> dataset_nn.groupby(<span class="st">"Store"</span>)[<span class="st">"Sales"</span>].rolling(<span class="dv">7</span>).mean().shift(<span class="dv">1</span>).reset_index(level<span class="op">=</span><span class="dv">0</span>, drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    first_idx_per_store <span class="op">=</span> dataset_nn.groupby(<span class="st">"Store"</span>).head(<span class="dv">1</span>).index</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    dataset_nn.loc[first_idx_per_store, <span class="st">"RollingMean7"</span>] <span class="op">=</span> <span class="bu">float</span>(<span class="st">"nan"</span>)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    dataset_nn[<span class="st">"SalesLag1Available"</span>] <span class="op">=</span> <span class="op">~</span>dataset_nn[<span class="st">"SalesLag1"</span>].isna() <span class="op">*</span> <span class="dv">1</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    dataset_nn[<span class="st">"SalesLag7Available"</span>] <span class="op">=</span> <span class="op">~</span>dataset_nn[<span class="st">"SalesLag7"</span>].isna() <span class="op">*</span> <span class="dv">1</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    dataset_nn[<span class="st">"RollingMean7Available"</span>] <span class="op">=</span> <span class="op">~</span>dataset_nn[<span class="st">"RollingMean7"</span>].isna() <span class="op">*</span> <span class="dv">1</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    dataset_nn.loc[:, dataset_nn.isna().<span class="bu">sum</span>() <span class="op">!=</span> <span class="dv">0</span>] <span class="op">=</span> dataset_nn.loc[:, dataset_nn.isna().<span class="bu">sum</span>() <span class="op">!=</span> <span class="dv">0</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="co"># ===== TRAIN, VALIDATION, </span><span class="al">TEST</span><span class="co"> SPLITTING =====</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>days_amount <span class="op">=</span> (dataset_nn.Date.iloc[<span class="op">-</span><span class="dv">1</span>,] <span class="op">-</span> dataset_nn.Date.iloc[<span class="dv">0</span>,])</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>test_split_time <span class="op">=</span> dataset_nn.Date.iloc[<span class="op">-</span><span class="dv">1</span>,] <span class="op">-</span> pd.Timedelta(days<span class="op">=</span><span class="bu">int</span>(days_amount.days<span class="op">*</span><span class="fl">0.05</span> <span class="op">-</span> <span class="dv">1</span>))</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>validation_split_time <span class="op">=</span> dataset_nn.Date.iloc[<span class="op">-</span><span class="dv">1</span>,] <span class="op">-</span> pd.Timedelta(days<span class="op">=</span><span class="bu">int</span>(days_amount.days<span class="op">*</span><span class="fl">0.1</span> <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>train_set_nn_clean <span class="op">=</span> dataset_nn[dataset_nn.Date <span class="op">&lt;</span> validation_split_time]</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>validation_set_nn_clean <span class="op">=</span> dataset_nn[(dataset_nn.Date <span class="op">&gt;=</span> validation_split_time) <span class="op">&amp;</span> (dataset_nn.Date <span class="op">&lt;</span> test_split_time)]</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>test_set_nn_clean <span class="op">=</span> dataset_nn[dataset_nn.Date <span class="op">&gt;=</span> test_split_time]</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>embed_cols <span class="op">=</span> [<span class="st">"Store"</span>] </span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>dummify_cols <span class="op">=</span> [<span class="st">"StateHoliday"</span>, <span class="st">"StoreType"</span>, <span class="st">"Assortment"</span>, <span class="st">"DayOfWeek"</span>] </span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a><span class="co"># num_cols have to be scaled (standardized to mean 0 and std of 1)</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>num_cols <span class="op">=</span> [</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SalesLag1"</span>, <span class="st">"SalesLag7"</span>, <span class="st">"RollingMean7"</span>, </span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">"LogCompetitionDistance"</span>, </span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">"CompetitionMonthsTotal"</span>, </span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Promo2MonthsTotal"</span>,</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Year"</span>, <span class="st">"Month"</span>, <span class="st">"Week"</span></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>binary_cols <span class="op">=</span> [</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Open"</span>, <span class="st">"Promo"</span>, <span class="st">"SchoolHoliday"</span>, <span class="st">"Promo2"</span>, <span class="st">"Promo2CurrentlyOn"</span>, <span class="st">"CompetitionMonthsKnown"</span>,</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SalesLag1Available"</span>, <span class="st">"SalesLag7Available"</span>, <span class="st">"RollingMean7Available"</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a><span class="co"># A ===== LOG TRANSFORMING =====</span></span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>train_set_nn <span class="op">=</span> train_set_nn_clean.copy()</span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>validation_set_nn <span class="op">=</span> validation_set_nn_clean.copy()</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>test_set_nn <span class="op">=</span> test_set_nn_clean.copy()</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> df_nn <span class="kw">in</span> (train_set_nn, validation_set_nn, test_set_nn):</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>    df_nn[<span class="st">"Sales_log"</span>] <span class="op">=</span> np.log1p(df_nn[<span class="st">"Sales"</span>])</span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>    df_nn[<span class="st">"Customers_log"</span>] <span class="op">=</span> np.log1p(df_nn[<span class="st">"Customers"</span>])</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a><span class="co"># B ===== ONE HOT ENCODING =====</span></span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>train_set_nn <span class="op">=</span> pd.get_dummies(train_set_nn, columns<span class="op">=</span>dummify_cols, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>validation_set_nn <span class="op">=</span> pd.get_dummies(validation_set_nn, columns<span class="op">=</span>dummify_cols, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>test_set_nn <span class="op">=</span> pd.get_dummies(test_set_nn, columns<span class="op">=</span>dummify_cols, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>train_cols <span class="op">=</span> train_set_nn.columns</span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>validation_set_nn <span class="op">=</span> validation_set_nn.reindex(columns<span class="op">=</span>train_cols, fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>test_set_nn <span class="op">=</span> test_set_nn.reindex(columns<span class="op">=</span>train_cols, fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>new_one_hot_features <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> train_set_nn.columns <span class="cf">if</span> <span class="bu">any</span>(x <span class="kw">in</span> c <span class="cf">for</span> x <span class="kw">in</span> dummify_cols)]</span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>all_binary_cols <span class="op">=</span> binary_cols <span class="op">+</span> new_one_hot_features</span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a><span class="co"># C ===== SCALING NUMERICAL VARIABLES =====</span></span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a>cols_to_scale <span class="op">=</span> num_cols <span class="op">+</span> [<span class="st">"Customers_log"</span>]</span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a><span class="co"># Scale (Overwrites columns in place)</span></span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a>train_set_nn[cols_to_scale] <span class="op">=</span> scaler.fit_transform(train_set_nn[cols_to_scale])</span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a>validation_set_nn[cols_to_scale] <span class="op">=</span> scaler.transform(validation_set_nn[cols_to_scale])</span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a>test_set_nn[cols_to_scale] <span class="op">=</span> scaler.transform(test_set_nn[cols_to_scale])</span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a><span class="co"># Save scaler stats for recursion later</span></span>
<span id="cb16-80"><a href="#cb16-80" aria-hidden="true" tabindex="-1"></a>cust_idx <span class="op">=</span> cols_to_scale.index(<span class="st">"Customers_log"</span>)</span>
<span id="cb16-81"><a href="#cb16-81" aria-hidden="true" tabindex="-1"></a>cust_mean <span class="op">=</span> scaler.mean_[cust_idx]</span>
<span id="cb16-82"><a href="#cb16-82" aria-hidden="true" tabindex="-1"></a>cust_scale <span class="op">=</span> scaler.scale_[cust_idx]</span>
<span id="cb16-83"><a href="#cb16-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-84"><a href="#cb16-84" aria-hidden="true" tabindex="-1"></a>cust_input_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> cols_to_scale <span class="cf">if</span> c <span class="op">!=</span> <span class="st">"Customers_log"</span>] <span class="op">+</span> all_binary_cols</span>
<span id="cb16-85"><a href="#cb16-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-86"><a href="#cb16-86" aria-hidden="true" tabindex="-1"></a><span class="co"># D ===== PREPARE DICTIONARY =====</span></span>
<span id="cb16-87"><a href="#cb16-87" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_inputs(df):</span>
<span id="cb16-88"><a href="#cb16-88" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> {</span>
<span id="cb16-89"><a href="#cb16-89" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input_Store"</span>: df[<span class="st">"Store"</span>].values.astype(<span class="bu">int</span>),</span>
<span id="cb16-90"><a href="#cb16-90" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input_numerical"</span>: df[cust_input_cols].values.astype(<span class="bu">float</span>)</span>
<span id="cb16-91"><a href="#cb16-91" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb16-92"><a href="#cb16-92" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> X</span>
<span id="cb16-93"><a href="#cb16-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-94"><a href="#cb16-94" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> prepare_inputs(train_set_nn)</span>
<span id="cb16-95"><a href="#cb16-95" aria-hidden="true" tabindex="-1"></a>X_val <span class="op">=</span> prepare_inputs(validation_set_nn)</span>
<span id="cb16-96"><a href="#cb16-96" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> prepare_inputs(test_set_nn)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Most of the categorical features contain only around 3-5 classes, so converting them into dummy variables does not increase dimensionality (substantially). On the other hand, the <span class="math inline">\(Store\)</span> variable contains 1115 unique store identifiers. One-hot encoding this variable would add 1115 binary columns to the data, rendering it hardly usable to any model.</p>
<div id="fig-nn-embedding" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-nn-embedding-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart LR
    D((Embedding model))
    subgraph Input[Input]
    A(Store: 1) 
    B(Store: 2) 
    dd(:)
    C(Store: 1115)
    end

    A --&gt; D
    B --&gt; D
    C --&gt; D
    
    subgraph Output[Output]
    F("[1.24, 4.15, ..., 2.53]")
    G("[3.14, 2.71, ..., 1.61]")
    ddd(:)
    H("[6.70, 6.98, ..., 4.27]")
    end

    D --&gt; F
    D --&gt; G
    D --&gt; H

    style A fill:#33628D,color:#FFF 
    style B fill:#33628D,color:#FFF
    style C fill:#33628D,color:#FFF
    style dd fill:#33628D,color:#FFF

    style D fill:#228C8D

    style F fill:#31B57B,color:#FFF
    style G fill:#31B57B,color:#FFF
    style H fill:#31B57B,color:#FFF
    style ddd fill:#31B57B,color:#FFF
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-nn-embedding-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Example of the embedding process
</figcaption>
</figure>
</div>
<p>For that reason we used embedding - the model learned the implications of the store numbers from the data, and saved them as a 10-dimensional vector. This way we reduced the dimensionality, while also preserving the original meaning of the variable.</p>
<div id="35c2e0fc" class="cell" data-execution_count="21">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_embedding_model(num_numerical_features, learning_rate<span class="op">=</span><span class="fl">0.001</span>):</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    store_input <span class="op">=</span> Input(shape<span class="op">=</span>(<span class="dv">1</span>,), name<span class="op">=</span><span class="st">"input_Store"</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Shrinking 1115 dimension spaces to a different vectors in R^10</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    store_embed <span class="op">=</span> Embedding(input_dim<span class="op">=</span><span class="dv">1116</span>, output_dim<span class="op">=</span><span class="dv">10</span>, name<span class="op">=</span><span class="st">"embed_Store"</span>)(store_input)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    store_embed <span class="op">=</span> Flatten()(store_embed)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    num_input <span class="op">=</span> Input(shape<span class="op">=</span>(num_numerical_features,), name<span class="op">=</span><span class="st">"input_numerical"</span>)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> Concatenate()([store_embed, num_input])</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> Dense(<span class="dv">128</span>, activation<span class="op">=</span><span class="st">'relu'</span>)(merged)</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> Dropout(<span class="fl">0.2</span>)(x)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> Dense(<span class="dv">128</span>, activation<span class="op">=</span><span class="st">'relu'</span>)(x)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> Dropout(<span class="fl">0.2</span>)(x)</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> Dense(<span class="dv">128</span>, activation<span class="op">=</span><span class="st">'relu'</span>)(x)</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> Dropout(<span class="fl">0.2</span>)(x)</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    output <span class="op">=</span> Dense(<span class="dv">1</span>)(x)</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> Model(inputs<span class="op">=</span>[store_input, num_input], outputs<span class="op">=</span>output)</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">compile</span>(optimizer<span class="op">=</span>Adam(learning_rate<span class="op">=</span>learning_rate), loss<span class="op">=</span><span class="st">"mse"</span>)</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>num_feats_cust <span class="op">=</span> X_train[<span class="st">'input_numerical'</span>].shape[<span class="dv">1</span>]</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>model_cust <span class="op">=</span> build_embedding_model(num_numerical_features<span class="op">=</span>num_feats_cust)</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>y_train_cust <span class="op">=</span> train_set_nn[<span class="st">'Customers_log'</span>].values</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>y_val_cust <span class="op">=</span> validation_set_nn[<span class="st">'Customers_log'</span>].values</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>callbacks_list <span class="op">=</span> [</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>    EarlyStopping(</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>        monitor<span class="op">=</span><span class="st">'val_loss'</span>, </span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>        patience<span class="op">=</span><span class="dv">3</span>, </span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>        restore_best_weights<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>        verbose<span class="op">=</span><span class="dv">1</span></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>y_train_cust <span class="op">=</span> np.log1p(train_set[<span class="st">'Customers'</span>].values)</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>y_val_cust   <span class="op">=</span> np.log1p(validation_set[<span class="st">'Customers'</span>].values)</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>history_cust <span class="op">=</span> model_cust.fit(</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>    X_train, y_train_cust,</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>    validation_data<span class="op">=</span>(X_val, y_val_cust),</span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>    epochs<span class="op">=</span><span class="dv">50</span>, </span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span><span class="dv">512</span>,</span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>    callbacks<span class="op">=</span>callbacks_list,</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="dv">1</span></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>pred_cust_log <span class="op">=</span> model_cust.predict(X_test, verbose<span class="op">=</span><span class="dv">0</span>).flatten()</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>pred_cust_real <span class="op">=</span> np.expm1(pred_cust_log)</span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>pred_cust_real <span class="op">=</span> np.maximum(pred_cust_real, <span class="dv">0</span>)</span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>is_open <span class="op">=</span> test_set[<span class="st">'Open'</span>].values</span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>sample_preds <span class="op">=</span> pred_cust_real[is_open <span class="op">==</span> <span class="dv">1</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">3.5 Results</h2>
<!-- -->

</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Rossmann sales prediction"</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Filip Šajtlava, Vojtěch Andrle"</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="an">jupyter:</span><span class="co"> m9dm2_project</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "today"</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co">    html:</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co">        toc: true</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co">        code-fold: true</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co">        code-tools:</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co">            source: true</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="co">            toggle: true</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="co">            caption: "Show the code"</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="co">        code-summary: "Show the code"</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="co">        css: styles.css</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="an">theme:</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="co">    light: flatly</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="co">#highlight-style: github</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a><span class="co">#| </span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> lightgbm <span class="im">as</span> lgb</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shap</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestRegressor</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error, r2_score</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.tree <span class="im">import</span> plot_tree</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> itertools</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gc</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.layers <span class="im">import</span> Input, Embedding, Flatten, Dense, Concatenate, Dropout</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.models <span class="im">import</span> Model</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.optimizers <span class="im">import</span> Adam</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.callbacks <span class="im">import</span> EarlyStopping</span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>vir_col <span class="op">=</span> plt.get_cmap(<span class="st">"viridis"</span>)</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>plt.style.use(<span class="st">"ggplot"</span>)</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"text.color"</span>] <span class="op">=</span> <span class="st">"black"</span></span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"axes.labelcolor"</span>] <span class="op">=</span> <span class="st">"black"</span></span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"xtick.color"</span>] <span class="op">=</span> <span class="st">"black"</span></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"ytick.color"</span>] <span class="op">=</span> <span class="st">"black"</span></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"axes.edgecolor"</span>] <span class="op">=</span> <span class="st">"black"</span></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a><span class="fu"># 3 Modeling</span></span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a><span class="fu">## 3.1 Model Selection</span></span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>We compare three models in our analysis:</span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>i. **Random Forests**,</span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a>ii. **LightGBM**,</span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>iii. **Neural Networks**.</span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a>To evaluate their performance, we use the Root Mean Squared Percentage Error ($\text{RMSPE}$), defined as:</span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a>$$ \text{RMSPE}(\mathbf{y}, \mathbf{\widehat{y}}) = \sqrt{\frac{1}{n} \sum_{i=1}^n \left( \frac{y_i - \widehat{y}_i}{y_i} \right)^2}$$</span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a>The best achieved performance on this dataset was $\text{RMSPE} \approx 0.10$. We keep this benchmark in mind when comparing our own models.</span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3.1.1 Data Preparation (again)</span></span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a>Due to autocorrelation, it is useful to include recent sales information (along with their corresponding dummy availability variables):</span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$SalesLag1$</span>
<span id="cb18-75"><a href="#cb18-75" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$SalesLag2$</span>
<span id="cb18-76"><a href="#cb18-76" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$RollingMean7$</span>
<span id="cb18-77"><a href="#cb18-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-78"><a href="#cb18-78" aria-hidden="true" tabindex="-1"></a>These allow us to have the model look back at the sales in the near past, possibly strengthening the prediction.</span>
<span id="cb18-79"><a href="#cb18-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-80"><a href="#cb18-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-81"><a href="#cb18-81" aria-hidden="true" tabindex="-1"></a>The original dataset on <span class="co">[</span><span class="ot">Kaggle.com</span><span class="co">](https://www.kaggle.com/c/rossmann-store-sales)</span> included both training and testing data, but since the official competition ended a decade ago, the actual true testing outcomes $\mathbf{y}$ $(Sales)$ are not available. For this reason, we split the data ourselves, with the test data having approximately 6 weeks (consistent with the length of the original competition’s test period).</span>
<span id="cb18-82"><a href="#cb18-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-85"><a href="#cb18-85" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb18-86"><a href="#cb18-86" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> pd.read_pickle(<span class="st">"../train_clean.pkl"</span>)</span>
<span id="cb18-87"><a href="#cb18-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-88"><a href="#cb18-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Due to autocorrelation surfacing in the visualization part, we"re going to add </span></span>
<span id="cb18-89"><a href="#cb18-89" aria-hidden="true" tabindex="-1"></a><span class="co"># lag and rolling mean</span></span>
<span id="cb18-90"><a href="#cb18-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-91"><a href="#cb18-91" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> dataset.sort_values(by<span class="op">=</span>[<span class="st">"Store"</span>, <span class="st">"Date"</span>]).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-92"><a href="#cb18-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-93"><a href="#cb18-93" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> warnings.catch_warnings():</span>
<span id="cb18-94"><a href="#cb18-94" aria-hidden="true" tabindex="-1"></a>    warnings.simplefilter(<span class="st">"ignore"</span>)</span>
<span id="cb18-95"><a href="#cb18-95" aria-hidden="true" tabindex="-1"></a>    dataset[<span class="st">"SalesLag1"</span>] <span class="op">=</span> dataset.groupby(<span class="st">"Store"</span>)[<span class="st">"Sales"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb18-96"><a href="#cb18-96" aria-hidden="true" tabindex="-1"></a>    dataset[<span class="st">"SalesLag7"</span>] <span class="op">=</span> dataset.groupby(<span class="st">"Store"</span>)[<span class="st">"Sales"</span>].shift(<span class="dv">7</span>)</span>
<span id="cb18-97"><a href="#cb18-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-98"><a href="#cb18-98" aria-hidden="true" tabindex="-1"></a>    dataset[<span class="st">"RollingMean7"</span>] <span class="op">=</span> dataset.groupby(<span class="st">"Store"</span>)[<span class="st">"Sales"</span>].rolling(<span class="dv">7</span>).mean().shift(<span class="dv">1</span>).reset_index(level<span class="op">=</span><span class="dv">0</span>, drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-99"><a href="#cb18-99" aria-hidden="true" tabindex="-1"></a>    first_idx_per_store <span class="op">=</span> dataset.groupby(<span class="st">"Store"</span>).head(<span class="dv">1</span>).index</span>
<span id="cb18-100"><a href="#cb18-100" aria-hidden="true" tabindex="-1"></a>    dataset.loc[first_idx_per_store, <span class="st">"RollingMean7"</span>] <span class="op">=</span> <span class="bu">float</span>(<span class="st">"nan"</span>)</span>
<span id="cb18-101"><a href="#cb18-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-102"><a href="#cb18-102" aria-hidden="true" tabindex="-1"></a>    dataset[<span class="st">"SalesLag1Available"</span>] <span class="op">=</span> <span class="op">~</span>dataset[<span class="st">"SalesLag1"</span>].isna() <span class="op">*</span> <span class="dv">1</span></span>
<span id="cb18-103"><a href="#cb18-103" aria-hidden="true" tabindex="-1"></a>    dataset[<span class="st">"SalesLag7Available"</span>] <span class="op">=</span> <span class="op">~</span>dataset[<span class="st">"SalesLag7"</span>].isna() <span class="op">*</span> <span class="dv">1</span></span>
<span id="cb18-104"><a href="#cb18-104" aria-hidden="true" tabindex="-1"></a>    dataset[<span class="st">"RollingMean7Available"</span>] <span class="op">=</span> <span class="op">~</span>dataset[<span class="st">"RollingMean7"</span>].isna() <span class="op">*</span> <span class="dv">1</span></span>
<span id="cb18-105"><a href="#cb18-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-106"><a href="#cb18-106" aria-hidden="true" tabindex="-1"></a>    dataset.loc[:, dataset.isna().<span class="bu">sum</span>() <span class="op">!=</span> <span class="dv">0</span>] <span class="op">=</span> dataset.loc[:, dataset.isna().<span class="bu">sum</span>() <span class="op">!=</span> <span class="dv">0</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb18-107"><a href="#cb18-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-108"><a href="#cb18-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-109"><a href="#cb18-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-110"><a href="#cb18-110" aria-hidden="true" tabindex="-1"></a>    <span class="co">### Split the dataset into 3 disjunct sets</span></span>
<span id="cb18-111"><a href="#cb18-111" aria-hidden="true" tabindex="-1"></a>    days_amount <span class="op">=</span> (dataset.Date.iloc[<span class="op">-</span><span class="dv">1</span>,] <span class="op">-</span> dataset.Date.iloc[<span class="dv">0</span>,])</span>
<span id="cb18-112"><a href="#cb18-112" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"The entire dataset is"</span>, days_amount.days, <span class="st">"days long"</span>)</span>
<span id="cb18-113"><a href="#cb18-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-114"><a href="#cb18-114" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We will do 90-5-5 split to align with the original kaggle prediction expectations</span></span>
<span id="cb18-115"><a href="#cb18-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-116"><a href="#cb18-116" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Gets the last date information and goes back around 5% of the dataset (the -1 corrects from sunday to monday)</span></span>
<span id="cb18-117"><a href="#cb18-117" aria-hidden="true" tabindex="-1"></a>    test_split_time <span class="op">=</span> dataset.Date.iloc[<span class="op">-</span><span class="dv">1</span>,] <span class="op">-</span> pd.Timedelta(days<span class="op">=</span><span class="bu">int</span>(days_amount.days<span class="op">*</span><span class="fl">0.05</span> <span class="op">-</span> <span class="dv">1</span>))</span>
<span id="cb18-118"><a href="#cb18-118" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Same for the validation data</span></span>
<span id="cb18-119"><a href="#cb18-119" aria-hidden="true" tabindex="-1"></a>    validation_split_time <span class="op">=</span> dataset.Date.iloc[<span class="op">-</span><span class="dv">1</span>,] <span class="op">-</span> pd.Timedelta(days<span class="op">=</span><span class="bu">int</span>(days_amount.days<span class="op">*</span><span class="fl">0.1</span> <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb18-120"><a href="#cb18-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-121"><a href="#cb18-121" aria-hidden="true" tabindex="-1"></a>    train_set <span class="op">=</span> dataset[dataset.Date <span class="op">&lt;</span> validation_split_time]</span>
<span id="cb18-122"><a href="#cb18-122" aria-hidden="true" tabindex="-1"></a>    validation_set <span class="op">=</span> dataset[(dataset.Date <span class="op">&gt;=</span> validation_split_time) <span class="op">&amp;</span> (dataset.Date <span class="op">&lt;</span> test_split_time)]</span>
<span id="cb18-123"><a href="#cb18-123" aria-hidden="true" tabindex="-1"></a>    test_set <span class="op">=</span> dataset[dataset.Date <span class="op">&gt;=</span> test_split_time]</span>
<span id="cb18-124"><a href="#cb18-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-125"><a href="#cb18-125" aria-hidden="true" tabindex="-1"></a>    newly_created_sets <span class="op">=</span> ((train_set, <span class="st">"training set"</span>), (validation_set, <span class="st">"validation set"</span>), (test_set, <span class="st">"testing set"</span>))</span>
<span id="cb18-126"><a href="#cb18-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-127"><a href="#cb18-127" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if the division went well</span></span>
<span id="cb18-128"><a href="#cb18-128" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> data_partition, name <span class="kw">in</span> newly_created_sets:</span>
<span id="cb18-129"><a href="#cb18-129" aria-hidden="true" tabindex="-1"></a>        display(data_partition.Date.iloc[[<span class="op">-</span><span class="dv">1</span>,<span class="dv">0</span>],])</span>
<span id="cb18-130"><a href="#cb18-130" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"The </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> makes up </span><span class="sc">{</span>data_partition<span class="sc">.</span>shape[<span class="dv">0</span>] <span class="op">*</span> <span class="dv">100</span> <span class="op">/</span> dataset<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:.2f}</span><span class="ss"> % of the dataset"</span>)</span>
<span id="cb18-131"><a href="#cb18-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-132"><a href="#cb18-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-133"><a href="#cb18-133" aria-hidden="true" tabindex="-1"></a>    holiday_map <span class="op">=</span> {<span class="st">"0"</span>: <span class="dv">0</span>, <span class="st">"a"</span>: <span class="dv">1</span>, <span class="st">"b"</span>: <span class="dv">2</span>, <span class="st">"c"</span>: <span class="dv">3</span>}</span>
<span id="cb18-134"><a href="#cb18-134" aria-hidden="true" tabindex="-1"></a>    storetype_map <span class="op">=</span> {<span class="st">"a"</span>: <span class="dv">0</span>, <span class="st">"b"</span>: <span class="dv">1</span>, <span class="st">"c"</span>: <span class="dv">2</span>, <span class="st">"d"</span>: <span class="dv">3</span>}</span>
<span id="cb18-135"><a href="#cb18-135" aria-hidden="true" tabindex="-1"></a>    assortment_map <span class="op">=</span> {<span class="st">"a"</span>: <span class="dv">0</span>, <span class="st">"b"</span>: <span class="dv">1</span>, <span class="st">"c"</span>: <span class="dv">2</span>}</span>
<span id="cb18-136"><a href="#cb18-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-137"><a href="#cb18-137" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> warnings.catch_warnings():</span>
<span id="cb18-138"><a href="#cb18-138" aria-hidden="true" tabindex="-1"></a>        warnings.simplefilter(<span class="st">"ignore"</span>)</span>
<span id="cb18-139"><a href="#cb18-139" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> df <span class="kw">in</span> (train_set, validation_set, test_set):</span>
<span id="cb18-140"><a href="#cb18-140" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">"StateHoliday"</span>] <span class="op">=</span> df[<span class="st">"StateHoliday"</span>].<span class="bu">map</span>(holiday_map).astype(<span class="bu">int</span>)</span>
<span id="cb18-141"><a href="#cb18-141" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">"StoreType"</span>] <span class="op">=</span> df[<span class="st">"StoreType"</span>].<span class="bu">map</span>(storetype_map).astype(<span class="bu">int</span>)</span>
<span id="cb18-142"><a href="#cb18-142" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">"Assortment"</span>] <span class="op">=</span> df[<span class="st">"Assortment"</span>].<span class="bu">map</span>(assortment_map).astype(<span class="bu">int</span>)</span>
<span id="cb18-143"><a href="#cb18-143" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-144"><a href="#cb18-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-147"><a href="#cb18-147" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb18-148"><a href="#cb18-148" aria-hidden="true" tabindex="-1"></a>train_set_open <span class="op">=</span> train_set.loc[train_set.Open <span class="op">==</span> <span class="dv">1</span>, :]</span>
<span id="cb18-149"><a href="#cb18-149" aria-hidden="true" tabindex="-1"></a>validation_set_open <span class="op">=</span> validation_set.loc[validation_set.Open <span class="op">==</span> <span class="dv">1</span>, :]</span>
<span id="cb18-150"><a href="#cb18-150" aria-hidden="true" tabindex="-1"></a>test_set_open <span class="op">=</span> test_set.loc[test_set.Open <span class="op">==</span> <span class="dv">1</span>, :]</span>
<span id="cb18-151"><a href="#cb18-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-152"><a href="#cb18-152" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rmspe(y_true, y_pred):</span>
<span id="cb18-153"><a href="#cb18-153" aria-hidden="true" tabindex="-1"></a>    y_true <span class="op">=</span> np.array(y_true)</span>
<span id="cb18-154"><a href="#cb18-154" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> np.array(y_pred)</span>
<span id="cb18-155"><a href="#cb18-155" aria-hidden="true" tabindex="-1"></a>    non_zero_idx <span class="op">=</span> y_true <span class="op">!=</span> <span class="dv">0</span></span>
<span id="cb18-156"><a href="#cb18-156" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.sqrt(np.mean(((y_true[non_zero_idx] <span class="op">-</span> y_pred[non_zero_idx]) <span class="op">/</span> y_true[non_zero_idx])<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb18-157"><a href="#cb18-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-158"><a href="#cb18-158" aria-hidden="true" tabindex="-1"></a>dataset.loc[dataset.Store <span class="op">==</span> <span class="dv">1</span>, :].head(<span class="dv">5</span>)</span>
<span id="cb18-159"><a href="#cb18-159" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-160"><a href="#cb18-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-161"><a href="#cb18-161" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3.1.2 Modeling Approach</span></span>
<span id="cb18-162"><a href="#cb18-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-163"><a href="#cb18-163" aria-hidden="true" tabindex="-1"></a>The true testing set is missing not only the target $Sales$ but also the customer count. One option would be to model $Sales$</span>
<span id="cb18-164"><a href="#cb18-164" aria-hidden="true" tabindex="-1"></a>directly and let the model accurately predict customer effect. In our approach however, we model the customers individually first, and only after getting the customers values, predict the true sales with a $Sales$ model that utilizes customer count.</span>
<span id="cb18-165"><a href="#cb18-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-166"><a href="#cb18-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-167"><a href="#cb18-167" aria-hidden="true" tabindex="-1"></a>::: {#fig-model-flowchart fig-cap="Basic flowchart of the modeling process" fig-align="center"}</span>
<span id="cb18-170"><a href="#cb18-170" aria-hidden="true" tabindex="-1"></a><span class="in">```{mermaid}</span></span>
<span id="cb18-171"><a href="#cb18-171" aria-hidden="true" tabindex="-1"></a>flowchart TB</span>
<span id="cb18-172"><a href="#cb18-172" aria-hidden="true" tabindex="-1"></a>    T(Test set)</span>
<span id="cb18-173"><a href="#cb18-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-174"><a href="#cb18-174" aria-hidden="true" tabindex="-1"></a>    subgraph CUSTOMERS[Customer Part]</span>
<span id="cb18-175"><a href="#cb18-175" aria-hidden="true" tabindex="-1"></a>    A(Fit a customers only model) </span>
<span id="cb18-176"><a href="#cb18-176" aria-hidden="true" tabindex="-1"></a>    D(Validation set)</span>
<span id="cb18-177"><a href="#cb18-177" aria-hidden="true" tabindex="-1"></a>    D -.-&gt; |validate|A</span>
<span id="cb18-178"><a href="#cb18-178" aria-hidden="true" tabindex="-1"></a>    A -.-&gt; |train|D(Validation set)</span>
<span id="cb18-179"><a href="#cb18-179" aria-hidden="true" tabindex="-1"></a>    A --&gt; E([Model selected])</span>
<span id="cb18-180"><a href="#cb18-180" aria-hidden="true" tabindex="-1"></a>    end</span>
<span id="cb18-181"><a href="#cb18-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-182"><a href="#cb18-182" aria-hidden="true" tabindex="-1"></a>    subgraph SALES[Sales Part]</span>
<span id="cb18-183"><a href="#cb18-183" aria-hidden="true" tabindex="-1"></a>    B(<span class="ot">"</span><span class="st">Fit a sales model</span><span class="ot">"</span>)</span>
<span id="cb18-184"><a href="#cb18-184" aria-hidden="true" tabindex="-1"></a>    DD -.-&gt; |validate|B</span>
<span id="cb18-185"><a href="#cb18-185" aria-hidden="true" tabindex="-1"></a>    B -.-&gt; |train|DD(Validation set)</span>
<span id="cb18-186"><a href="#cb18-186" aria-hidden="true" tabindex="-1"></a>    B --&gt; G([Model selected])</span>
<span id="cb18-187"><a href="#cb18-187" aria-hidden="true" tabindex="-1"></a>    E --&gt; |Add the customers to the test set| T</span>
<span id="cb18-188"><a href="#cb18-188" aria-hidden="true" tabindex="-1"></a>    end</span>
<span id="cb18-189"><a href="#cb18-189" aria-hidden="true" tabindex="-1"></a>    G --&gt; |<span class="ot">"</span><span class="st">Predict the sales</span><span class="ot">"</span>| I</span>
<span id="cb18-190"><a href="#cb18-190" aria-hidden="true" tabindex="-1"></a>    T --&gt; I([Sales RMSPE])</span>
<span id="cb18-191"><a href="#cb18-191" aria-hidden="true" tabindex="-1"></a>    E --&gt; |Predict the customers| H([Customers RMSPE])</span>
<span id="cb18-192"><a href="#cb18-192" aria-hidden="true" tabindex="-1"></a>    T --&gt; H</span>
<span id="cb18-193"><a href="#cb18-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-194"><a href="#cb18-194" aria-hidden="true" tabindex="-1"></a>    style G fill:<span class="co">#228C8D</span></span>
<span id="cb18-195"><a href="#cb18-195" aria-hidden="true" tabindex="-1"></a>    style E fill:<span class="co">#228C8D</span></span>
<span id="cb18-196"><a href="#cb18-196" aria-hidden="true" tabindex="-1"></a>    style A fill:<span class="co">#33628D,color:#FFF </span></span>
<span id="cb18-197"><a href="#cb18-197" aria-hidden="true" tabindex="-1"></a>    style B fill:<span class="co">#33628D,color:#FFF</span></span>
<span id="cb18-198"><a href="#cb18-198" aria-hidden="true" tabindex="-1"></a>    style I fill:<span class="co">#31B57B</span></span>
<span id="cb18-199"><a href="#cb18-199" aria-hidden="true" tabindex="-1"></a>    style H fill:<span class="co">#31B57B</span></span>
<span id="cb18-200"><a href="#cb18-200" aria-hidden="true" tabindex="-1"></a>    style DD fill:<span class="co">#f1f2f6,stroke-dasharray: 10 5,stroke:#1b2026</span></span>
<span id="cb18-201"><a href="#cb18-201" aria-hidden="true" tabindex="-1"></a>    style D fill:<span class="co">#f1f2f6,stroke-dasharray: 10 5,stroke:#1b2026</span></span>
<span id="cb18-202"><a href="#cb18-202" aria-hidden="true" tabindex="-1"></a>    style T fill:<span class="co">#f1f2f6,stroke-dasharray: 10 5,stroke:#1b2026</span></span>
<span id="cb18-203"><a href="#cb18-203" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-204"><a href="#cb18-204" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb18-205"><a href="#cb18-205" aria-hidden="true" tabindex="-1"></a>Next, we need to incorporate the lag features. The main problem is that these values are not known in advance, so the $Sales$ model cannot be applied on the entire dataset at once. </span>
<span id="cb18-206"><a href="#cb18-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-207"><a href="#cb18-207" aria-hidden="true" tabindex="-1"></a>To solve this issue, we can use the $Sales$ model recursively, adding a single observation of sales and updating the lag features and rolling averages accordingly.</span>
<span id="cb18-208"><a href="#cb18-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-209"><a href="#cb18-209" aria-hidden="true" tabindex="-1"></a>The main problems:</span>
<span id="cb18-210"><a href="#cb18-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-211"><a href="#cb18-211" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Modeling sales based on predicted values ($Customers$)</span>
<span id="cb18-212"><a href="#cb18-212" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Recursive modeling using lags and rolling mean - propagating the error and compounding innacuracies.</span>
<span id="cb18-213"><a href="#cb18-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-214"><a href="#cb18-214" aria-hidden="true" tabindex="-1"></a><span class="fu">## 3.2 Random Forests</span></span>
<span id="cb18-215"><a href="#cb18-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-216"><a href="#cb18-216" aria-hidden="true" tabindex="-1"></a><span class="al">![Schema of bootstrap aggregating](images/tikz_bagging.png)</span>{#fig-static-image}</span>
<span id="cb18-217"><a href="#cb18-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-218"><a href="#cb18-218" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3.2.1 Naive Modeling</span></span>
<span id="cb18-219"><a href="#cb18-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-220"><a href="#cb18-220" aria-hidden="true" tabindex="-1"></a>We can try and compare the naive approach (modeling the $Sales$ without the customers) and the customers + recursion approach.</span>
<span id="cb18-221"><a href="#cb18-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-224"><a href="#cb18-224" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb18-225"><a href="#cb18-225" aria-hidden="true" tabindex="-1"></a>ignore_cols <span class="op">=</span> [<span class="st">"Sales"</span>, <span class="st">"Customers"</span>, <span class="st">"Date"</span>] </span>
<span id="cb18-226"><a href="#cb18-226" aria-hidden="true" tabindex="-1"></a>lag_cols <span class="op">=</span> [<span class="st">"SalesLag1"</span>, <span class="st">"SalesLag7"</span>, <span class="st">"RollingMean7"</span>, <span class="st">"SalesLag1Available"</span>, <span class="st">"SalesLag7Available"</span>, <span class="st">"RollingMean7Available"</span>]</span>
<span id="cb18-227"><a href="#cb18-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-228"><a href="#cb18-228" aria-hidden="true" tabindex="-1"></a>cols_to_select <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> train_set_open.columns <span class="cf">if</span> col <span class="kw">not</span> <span class="kw">in</span> ignore_cols <span class="kw">and</span> col <span class="kw">not</span> <span class="kw">in</span> lag_cols]</span>
<span id="cb18-229"><a href="#cb18-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-230"><a href="#cb18-230" aria-hidden="true" tabindex="-1"></a>x_train_naive <span class="op">=</span> train_set_open.loc[:, cols_to_select]</span>
<span id="cb18-231"><a href="#cb18-231" aria-hidden="true" tabindex="-1"></a>y_train_naive <span class="op">=</span> train_set_open.loc[:, <span class="st">"Sales"</span>]</span>
<span id="cb18-232"><a href="#cb18-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-233"><a href="#cb18-233" aria-hidden="true" tabindex="-1"></a>x_val_naive <span class="op">=</span> validation_set_open.loc[:, cols_to_select]</span>
<span id="cb18-234"><a href="#cb18-234" aria-hidden="true" tabindex="-1"></a>y_val_naive <span class="op">=</span> validation_set_open.loc[:, <span class="st">"Sales"</span>]</span>
<span id="cb18-235"><a href="#cb18-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-236"><a href="#cb18-236" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> grid_search(param_grid, model_type, x_train, y_train, x_val, y_val, n_jobs, verbose <span class="op">=</span> <span class="va">False</span>):</span>
<span id="cb18-237"><a href="#cb18-237" aria-hidden="true" tabindex="-1"></a>    keys, values <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>param_grid.items())</span>
<span id="cb18-238"><a href="#cb18-238" aria-hidden="true" tabindex="-1"></a>    param_combinations <span class="op">=</span> [<span class="bu">dict</span>(<span class="bu">zip</span>(keys, v)) <span class="cf">for</span> v <span class="kw">in</span> itertools.product(<span class="op">*</span>values)]</span>
<span id="cb18-239"><a href="#cb18-239" aria-hidden="true" tabindex="-1"></a>    results_data <span class="op">=</span> []</span>
<span id="cb18-240"><a href="#cb18-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-241"><a href="#cb18-241" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, params <span class="kw">in</span> <span class="bu">enumerate</span>(param_combinations):</span>
<span id="cb18-242"><a href="#cb18-242" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> model_type(</span>
<span id="cb18-243"><a href="#cb18-243" aria-hidden="true" tabindex="-1"></a>            <span class="op">**</span>params,</span>
<span id="cb18-244"><a href="#cb18-244" aria-hidden="true" tabindex="-1"></a>            random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb18-245"><a href="#cb18-245" aria-hidden="true" tabindex="-1"></a>            n_jobs<span class="op">=</span>n_jobs,</span>
<span id="cb18-246"><a href="#cb18-246" aria-hidden="true" tabindex="-1"></a>            verbose<span class="op">=</span><span class="dv">0</span></span>
<span id="cb18-247"><a href="#cb18-247" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb18-248"><a href="#cb18-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-249"><a href="#cb18-249" aria-hidden="true" tabindex="-1"></a>        model.fit(x_train, y_train)</span>
<span id="cb18-250"><a href="#cb18-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-251"><a href="#cb18-251" aria-hidden="true" tabindex="-1"></a>        y_train_predicted <span class="op">=</span> model.predict(x_train)</span>
<span id="cb18-252"><a href="#cb18-252" aria-hidden="true" tabindex="-1"></a>        y_val_predicted <span class="op">=</span> model.predict(x_val)</span>
<span id="cb18-253"><a href="#cb18-253" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-254"><a href="#cb18-254" aria-hidden="true" tabindex="-1"></a>        mse_train <span class="op">=</span> mean_squared_error(y_train, y_train_predicted)</span>
<span id="cb18-255"><a href="#cb18-255" aria-hidden="true" tabindex="-1"></a>        rmse_train <span class="op">=</span> mse_train <span class="op">**</span> <span class="fl">0.5</span></span>
<span id="cb18-256"><a href="#cb18-256" aria-hidden="true" tabindex="-1"></a>        r2_train <span class="op">=</span> r2_score(y_train, y_train_predicted)</span>
<span id="cb18-257"><a href="#cb18-257" aria-hidden="true" tabindex="-1"></a>        rmspe_train <span class="op">=</span> rmspe(y_train, y_train_predicted)</span>
<span id="cb18-258"><a href="#cb18-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-259"><a href="#cb18-259" aria-hidden="true" tabindex="-1"></a>        mse_val <span class="op">=</span> mean_squared_error(y_val, y_val_predicted)</span>
<span id="cb18-260"><a href="#cb18-260" aria-hidden="true" tabindex="-1"></a>        rmse_val <span class="op">=</span> mse_val <span class="op">**</span> <span class="fl">0.5</span></span>
<span id="cb18-261"><a href="#cb18-261" aria-hidden="true" tabindex="-1"></a>        r2_val <span class="op">=</span> r2_score(y_val, y_val_predicted)</span>
<span id="cb18-262"><a href="#cb18-262" aria-hidden="true" tabindex="-1"></a>        rmspe_val <span class="op">=</span> rmspe(y_val, y_val_predicted)</span>
<span id="cb18-263"><a href="#cb18-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-264"><a href="#cb18-264" aria-hidden="true" tabindex="-1"></a>        results_entry <span class="op">=</span> params.copy()</span>
<span id="cb18-265"><a href="#cb18-265" aria-hidden="true" tabindex="-1"></a>        results_entry[<span class="st">"Train_RMSPE"</span>] <span class="op">=</span> rmspe_train</span>
<span id="cb18-266"><a href="#cb18-266" aria-hidden="true" tabindex="-1"></a>        results_entry[<span class="st">"Val_RMSPE"</span>] <span class="op">=</span> rmspe_val</span>
<span id="cb18-267"><a href="#cb18-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-268"><a href="#cb18-268" aria-hidden="true" tabindex="-1"></a>        results_data.append(results_entry)</span>
<span id="cb18-269"><a href="#cb18-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-270"><a href="#cb18-270" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> verbose:</span>
<span id="cb18-271"><a href="#cb18-271" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"==== TRAINING ==== (</span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(param_combinations)<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb18-272"><a href="#cb18-272" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Train RMSE: </span><span class="sc">{</span>rmse_train<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb18-273"><a href="#cb18-273" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Train R²: </span><span class="sc">{</span>r2_train<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb18-274"><a href="#cb18-274" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Train RMSPE: </span><span class="sc">{</span>rmspe_train<span class="sc">:.4f}</span><span class="ss"> (</span><span class="sc">{</span>rmspe_train<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb18-275"><a href="#cb18-275" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"==== TRAINING ===="</span>)</span>
<span id="cb18-276"><a href="#cb18-276" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>()</span>
<span id="cb18-277"><a href="#cb18-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-278"><a href="#cb18-278" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"==== VALIDATION ==== (</span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(param_combinations)<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb18-279"><a href="#cb18-279" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Validation RMSE: </span><span class="sc">{</span>rmse_val<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb18-280"><a href="#cb18-280" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Validation R²: </span><span class="sc">{</span>r2_val<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb18-281"><a href="#cb18-281" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Validation RMSPE: </span><span class="sc">{</span>rmspe_val<span class="sc">:.4f}</span><span class="ss"> (</span><span class="sc">{</span>rmspe_val<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb18-282"><a href="#cb18-282" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"==== VALIDATION ===="</span>)</span>
<span id="cb18-283"><a href="#cb18-283" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb18-284"><a href="#cb18-284" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"(</span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(param_combinations)<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb18-285"><a href="#cb18-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-286"><a href="#cb18-286" aria-hidden="true" tabindex="-1"></a>    results_df <span class="op">=</span> pd.DataFrame(results_data)</span>
<span id="cb18-287"><a href="#cb18-287" aria-hidden="true" tabindex="-1"></a>    results_df <span class="op">=</span> results_df.sort_values(by<span class="op">=</span><span class="st">"Val_RMSPE"</span>, ascending<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-288"><a href="#cb18-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-289"><a href="#cb18-289" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> verbose:</span>
<span id="cb18-290"><a href="#cb18-290" aria-hidden="true" tabindex="-1"></a>        display(results_df.head(<span class="dv">5</span>))</span>
<span id="cb18-291"><a href="#cb18-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-292"><a href="#cb18-292" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results_df</span>
<span id="cb18-293"><a href="#cb18-293" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-294"><a href="#cb18-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-295"><a href="#cb18-295" aria-hidden="true" tabindex="-1"></a>For tuning hyperparameters we will utilize a simple grid-search approach, comparing the training and validation RMSPE errors and selecting the ideal model with the smallest ones.</span>
<span id="cb18-296"><a href="#cb18-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-299"><a href="#cb18-299" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb18-300"><a href="#cb18-300" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-301"><a href="#cb18-301" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb18-302"><a href="#cb18-302" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb18-303"><a href="#cb18-303" aria-hidden="true" tabindex="-1"></a>param_grid_naive <span class="op">=</span> {</span>
<span id="cb18-304"><a href="#cb18-304" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_estimators"</span>: [<span class="dv">100</span>, <span class="dv">200</span>],</span>
<span id="cb18-305"><a href="#cb18-305" aria-hidden="true" tabindex="-1"></a>    <span class="st">"max_depth"</span>: [<span class="dv">50</span>, <span class="va">None</span>],</span>
<span id="cb18-306"><a href="#cb18-306" aria-hidden="true" tabindex="-1"></a>    <span class="st">"max_samples"</span>: [<span class="fl">0.6</span>, <span class="fl">0.8</span>, <span class="dv">1</span>],</span>
<span id="cb18-307"><a href="#cb18-307" aria-hidden="true" tabindex="-1"></a>    <span class="st">"max_features"</span>: [<span class="fl">0.5</span>, <span class="st">"sqrt"</span>, <span class="dv">1</span>]</span>
<span id="cb18-308"><a href="#cb18-308" aria-hidden="true" tabindex="-1"></a>    <span class="co">#"min_samples_split": [2, 5, 10],</span></span>
<span id="cb18-309"><a href="#cb18-309" aria-hidden="true" tabindex="-1"></a>    <span class="co">#"min_samples_leaf": [1, 2, 4]</span></span>
<span id="cb18-310"><a href="#cb18-310" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-311"><a href="#cb18-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-312"><a href="#cb18-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-313"><a href="#cb18-313" aria-hidden="true" tabindex="-1"></a><span class="co"># These models do NOT use the customers to predict the sales</span></span>
<span id="cb18-314"><a href="#cb18-314" aria-hidden="true" tabindex="-1"></a>results_naive <span class="op">=</span> grid_search(param_grid<span class="op">=</span>param_grid_naive,</span>
<span id="cb18-315"><a href="#cb18-315" aria-hidden="true" tabindex="-1"></a>                            model_type<span class="op">=</span>RandomForestRegressor,</span>
<span id="cb18-316"><a href="#cb18-316" aria-hidden="true" tabindex="-1"></a>                            x_train<span class="op">=</span>x_train_naive,</span>
<span id="cb18-317"><a href="#cb18-317" aria-hidden="true" tabindex="-1"></a>                            y_train<span class="op">=</span>y_train_naive,</span>
<span id="cb18-318"><a href="#cb18-318" aria-hidden="true" tabindex="-1"></a>                            x_val<span class="op">=</span>x_val_naive,</span>
<span id="cb18-319"><a href="#cb18-319" aria-hidden="true" tabindex="-1"></a>                            y_val<span class="op">=</span>y_val_naive,</span>
<span id="cb18-320"><a href="#cb18-320" aria-hidden="true" tabindex="-1"></a>                            n_jobs<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb18-321"><a href="#cb18-321" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-322"><a href="#cb18-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-323"><a href="#cb18-323" aria-hidden="true" tabindex="-1"></a>Best performing models with these parameter combinations:</span>
<span id="cb18-326"><a href="#cb18-326" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb18-327"><a href="#cb18-327" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb18-328"><a href="#cb18-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-329"><a href="#cb18-329" aria-hidden="true" tabindex="-1"></a>results_naive <span class="op">=</span> pd.read_csv(<span class="st">"../outputs/sales_naive_randomforest_grid.csv"</span>)</span>
<span id="cb18-330"><a href="#cb18-330" aria-hidden="true" tabindex="-1"></a>display(results_naive.head(<span class="dv">4</span>))</span>
<span id="cb18-331"><a href="#cb18-331" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-332"><a href="#cb18-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-333"><a href="#cb18-333" aria-hidden="true" tabindex="-1"></a>And the worst ones:</span>
<span id="cb18-336"><a href="#cb18-336" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb18-337"><a href="#cb18-337" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb18-338"><a href="#cb18-338" aria-hidden="true" tabindex="-1"></a>display(results_naive.tail(<span class="dv">4</span>))</span>
<span id="cb18-339"><a href="#cb18-339" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-340"><a href="#cb18-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-341"><a href="#cb18-341" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3.2.2 Recursive Modeling</span></span>
<span id="cb18-342"><a href="#cb18-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-345"><a href="#cb18-345" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb18-346"><a href="#cb18-346" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb18-347"><a href="#cb18-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-348"><a href="#cb18-348" aria-hidden="true" tabindex="-1"></a>results_cust <span class="op">=</span> pd.read_csv(<span class="st">"../outputs/customers_recursive_randomforest_grid_small.csv"</span>)</span>
<span id="cb18-349"><a href="#cb18-349" aria-hidden="true" tabindex="-1"></a>results_sales <span class="op">=</span> pd.read_csv(<span class="st">"../outputs/sales_recursive_randomforest_grid_small.csv"</span>)</span>
<span id="cb18-350"><a href="#cb18-350" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-351"><a href="#cb18-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-354"><a href="#cb18-354" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb18-355"><a href="#cb18-355" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-356"><a href="#cb18-356" aria-hidden="true" tabindex="-1"></a>cust_ignore_cols <span class="op">=</span> [<span class="st">"Sales"</span>, <span class="st">"Customers"</span>, <span class="st">"Date"</span>]</span>
<span id="cb18-357"><a href="#cb18-357" aria-hidden="true" tabindex="-1"></a>sales_ignore_cols <span class="op">=</span> [<span class="st">"Sales"</span>, <span class="st">"Date"</span>]</span>
<span id="cb18-358"><a href="#cb18-358" aria-hidden="true" tabindex="-1"></a>lag_cols <span class="op">=</span> [<span class="st">"SalesLag1"</span>, <span class="st">"SalesLag7"</span>, <span class="st">"RollingMean7"</span>, <span class="st">"SalesLag1Available"</span>, <span class="st">"SalesLag7Available"</span>, <span class="st">"RollingMean7Available"</span>]</span>
<span id="cb18-359"><a href="#cb18-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-360"><a href="#cb18-360" aria-hidden="true" tabindex="-1"></a>cols_to_select_cust <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> train_set_open.columns <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> cust_ignore_cols <span class="kw">and</span> c <span class="kw">not</span> <span class="kw">in</span> lag_cols]</span>
<span id="cb18-361"><a href="#cb18-361" aria-hidden="true" tabindex="-1"></a>cols_to_select_sales <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> train_set_open.columns <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> sales_ignore_cols]</span>
<span id="cb18-362"><a href="#cb18-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-363"><a href="#cb18-363" aria-hidden="true" tabindex="-1"></a>x_train_cust <span class="op">=</span> train_set_open[cols_to_select_cust]</span>
<span id="cb18-364"><a href="#cb18-364" aria-hidden="true" tabindex="-1"></a>y_train_cust <span class="op">=</span> train_set_open.loc[:, <span class="st">"Customers"</span>]</span>
<span id="cb18-365"><a href="#cb18-365" aria-hidden="true" tabindex="-1"></a>x_val_cust <span class="op">=</span> validation_set_open[cols_to_select_cust]</span>
<span id="cb18-366"><a href="#cb18-366" aria-hidden="true" tabindex="-1"></a>y_val_cust <span class="op">=</span> validation_set_open.loc[:, <span class="st">"Customers"</span>]</span>
<span id="cb18-367"><a href="#cb18-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-368"><a href="#cb18-368" aria-hidden="true" tabindex="-1"></a>x_train_sales <span class="op">=</span> train_set_open[cols_to_select_sales]</span>
<span id="cb18-369"><a href="#cb18-369" aria-hidden="true" tabindex="-1"></a>y_train_sales <span class="op">=</span> train_set_open.loc[:, <span class="st">"Sales"</span>]</span>
<span id="cb18-370"><a href="#cb18-370" aria-hidden="true" tabindex="-1"></a>x_val_sales <span class="op">=</span> validation_set_open[cols_to_select_sales]</span>
<span id="cb18-371"><a href="#cb18-371" aria-hidden="true" tabindex="-1"></a>y_val_sales <span class="op">=</span> validation_set_open.loc[:, <span class="st">"Sales"</span>]</span>
<span id="cb18-372"><a href="#cb18-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-373"><a href="#cb18-373" aria-hidden="true" tabindex="-1"></a>param_grid_cust <span class="op">=</span> {</span>
<span id="cb18-374"><a href="#cb18-374" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_estimators"</span>: [<span class="dv">50</span>, <span class="dv">100</span>],</span>
<span id="cb18-375"><a href="#cb18-375" aria-hidden="true" tabindex="-1"></a>    <span class="st">"max_depth"</span>: [<span class="dv">10</span>, <span class="dv">25</span>, <span class="dv">50</span>],</span>
<span id="cb18-376"><a href="#cb18-376" aria-hidden="true" tabindex="-1"></a>    <span class="st">"max_samples"</span>: [<span class="fl">0.6</span>, <span class="fl">0.8</span>],</span>
<span id="cb18-377"><a href="#cb18-377" aria-hidden="true" tabindex="-1"></a>    <span class="st">"max_features"</span>: [<span class="fl">0.5</span>, <span class="st">"sqrt"</span>]</span>
<span id="cb18-378"><a href="#cb18-378" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-379"><a href="#cb18-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-380"><a href="#cb18-380" aria-hidden="true" tabindex="-1"></a>results_cust <span class="op">=</span> grid_search(param_grid<span class="op">=</span>param_grid_cust,</span>
<span id="cb18-381"><a href="#cb18-381" aria-hidden="true" tabindex="-1"></a>                           model_type<span class="op">=</span>RandomForestRegressor,</span>
<span id="cb18-382"><a href="#cb18-382" aria-hidden="true" tabindex="-1"></a>                           x_train<span class="op">=</span>x_train_cust,</span>
<span id="cb18-383"><a href="#cb18-383" aria-hidden="true" tabindex="-1"></a>                           y_train<span class="op">=</span>y_train_cust,</span>
<span id="cb18-384"><a href="#cb18-384" aria-hidden="true" tabindex="-1"></a>                           x_val<span class="op">=</span>x_val_cust,</span>
<span id="cb18-385"><a href="#cb18-385" aria-hidden="true" tabindex="-1"></a>                           y_val<span class="op">=</span>y_val_cust,</span>
<span id="cb18-386"><a href="#cb18-386" aria-hidden="true" tabindex="-1"></a>                           n_jobs<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb18-387"><a href="#cb18-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-388"><a href="#cb18-388" aria-hidden="true" tabindex="-1"></a>param_grid_sales <span class="op">=</span> {</span>
<span id="cb18-389"><a href="#cb18-389" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_estimators"</span>: [<span class="dv">50</span>, <span class="dv">100</span>],</span>
<span id="cb18-390"><a href="#cb18-390" aria-hidden="true" tabindex="-1"></a>    <span class="st">"max_depth"</span>: [<span class="dv">10</span>, <span class="dv">25</span>, <span class="dv">50</span>],</span>
<span id="cb18-391"><a href="#cb18-391" aria-hidden="true" tabindex="-1"></a>    <span class="st">"max_samples"</span>: [<span class="fl">0.6</span>, <span class="fl">0.8</span>],</span>
<span id="cb18-392"><a href="#cb18-392" aria-hidden="true" tabindex="-1"></a>    <span class="st">"max_features"</span>: [<span class="fl">0.5</span>, <span class="st">"sqrt"</span>]</span>
<span id="cb18-393"><a href="#cb18-393" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-394"><a href="#cb18-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-395"><a href="#cb18-395" aria-hidden="true" tabindex="-1"></a>results_sales <span class="op">=</span> grid_search(param_grid<span class="op">=</span>param_grid_sales,</span>
<span id="cb18-396"><a href="#cb18-396" aria-hidden="true" tabindex="-1"></a>                            model_type<span class="op">=</span>RandomForestRegressor,</span>
<span id="cb18-397"><a href="#cb18-397" aria-hidden="true" tabindex="-1"></a>                            x_train<span class="op">=</span>x_train_sales,</span>
<span id="cb18-398"><a href="#cb18-398" aria-hidden="true" tabindex="-1"></a>                            y_train<span class="op">=</span>y_train_sales,</span>
<span id="cb18-399"><a href="#cb18-399" aria-hidden="true" tabindex="-1"></a>                            x_val<span class="op">=</span>x_val_sales,</span>
<span id="cb18-400"><a href="#cb18-400" aria-hidden="true" tabindex="-1"></a>                            y_val<span class="op">=</span>y_val_sales,</span>
<span id="cb18-401"><a href="#cb18-401" aria-hidden="true" tabindex="-1"></a>                            n_jobs<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb18-402"><a href="#cb18-402" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-403"><a href="#cb18-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-404"><a href="#cb18-404" aria-hidden="true" tabindex="-1"></a>For the resursive modeling, we need to optimize the hyperparameters of two distinct models. The first one being the classic $Customers$ model:</span>
<span id="cb18-405"><a href="#cb18-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-408"><a href="#cb18-408" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb18-409"><a href="#cb18-409" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb18-410"><a href="#cb18-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-411"><a href="#cb18-411" aria-hidden="true" tabindex="-1"></a>BEST_STYLE <span class="op">=</span> <span class="ss">f"background-color: #32648e; font-weight: bold; color: white"</span></span>
<span id="cb18-412"><a href="#cb18-412" aria-hidden="true" tabindex="-1"></a>SHOWCASE_STYLE <span class="op">=</span> <span class="ss">f"background-color: #21918c; font-weight: bold; color: white"</span></span>
<span id="cb18-413"><a href="#cb18-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-414"><a href="#cb18-414" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> apply_style(series, style_css):</span>
<span id="cb18-415"><a href="#cb18-415" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [style_css] <span class="op">*</span> <span class="bu">len</span>(series)</span>
<span id="cb18-416"><a href="#cb18-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-417"><a href="#cb18-417" aria-hidden="true" tabindex="-1"></a>styled_df <span class="op">=</span> results_cust.head(<span class="dv">4</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>).style</span>
<span id="cb18-418"><a href="#cb18-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-419"><a href="#cb18-419" aria-hidden="true" tabindex="-1"></a>styled_df <span class="op">=</span> styled_df.<span class="bu">apply</span>(</span>
<span id="cb18-420"><a href="#cb18-420" aria-hidden="true" tabindex="-1"></a>    apply_style, </span>
<span id="cb18-421"><a href="#cb18-421" aria-hidden="true" tabindex="-1"></a>    axis<span class="op">=</span><span class="dv">1</span>, </span>
<span id="cb18-422"><a href="#cb18-422" aria-hidden="true" tabindex="-1"></a>    style_css<span class="op">=</span>BEST_STYLE,</span>
<span id="cb18-423"><a href="#cb18-423" aria-hidden="true" tabindex="-1"></a>    subset<span class="op">=</span>([<span class="dv">0</span>], <span class="bu">slice</span>(<span class="va">None</span>))</span>
<span id="cb18-424"><a href="#cb18-424" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-425"><a href="#cb18-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-426"><a href="#cb18-426" aria-hidden="true" tabindex="-1"></a>styled_df <span class="op">=</span> styled_df.<span class="bu">apply</span>(</span>
<span id="cb18-427"><a href="#cb18-427" aria-hidden="true" tabindex="-1"></a>    apply_style, </span>
<span id="cb18-428"><a href="#cb18-428" aria-hidden="true" tabindex="-1"></a>    axis<span class="op">=</span><span class="dv">1</span>, </span>
<span id="cb18-429"><a href="#cb18-429" aria-hidden="true" tabindex="-1"></a>    style_css<span class="op">=</span>SHOWCASE_STYLE,</span>
<span id="cb18-430"><a href="#cb18-430" aria-hidden="true" tabindex="-1"></a>    subset<span class="op">=</span>([<span class="dv">1</span>], <span class="bu">slice</span>(<span class="va">None</span>))</span>
<span id="cb18-431"><a href="#cb18-431" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-432"><a href="#cb18-432" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-433"><a href="#cb18-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-434"><a href="#cb18-434" aria-hidden="true" tabindex="-1"></a>display(styled_df)</span>
<span id="cb18-435"><a href="#cb18-435" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-436"><a href="#cb18-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-437"><a href="#cb18-437" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">br</span><span class="dt">&gt;</span></span>
<span id="cb18-438"><a href="#cb18-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-439"><a href="#cb18-439" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> style</span><span class="op">=</span><span class="st">"display: flex; gap: 0; padding: 0; margin: 0;"</span><span class="dt">&gt;</span></span>
<span id="cb18-440"><a href="#cb18-440" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">img</span><span class="ot"> src</span><span class="op">=</span><span class="st">"images/tree_depths_cust_rf_best.png"</span><span class="ot"> style</span><span class="op">=</span><span class="st">"width: 49%; padding: 0; margin: 0; border: none;"</span><span class="dt">&gt;</span></span>
<span id="cb18-441"><a href="#cb18-441" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">img</span><span class="ot"> src</span><span class="op">=</span><span class="st">"images/tree_depths_cust_rf_showcase.png"</span><span class="ot"> style</span><span class="op">=</span><span class="st">"width: 49%; padding: 0; margin: 0; border: none;"</span><span class="dt">&gt;</span></span>
<span id="cb18-442"><a href="#cb18-442" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb18-443"><a href="#cb18-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-444"><a href="#cb18-444" aria-hidden="true" tabindex="-1"></a>Both of the tables show a very unusual situation, where the training error is actually higher than the validation error. This can happen because the validation set is very small, so the model finds it considerably easier to predict values there, compared to the training set with full yearly seasonality.</span>
<span id="cb18-445"><a href="#cb18-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-448"><a href="#cb18-448" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb18-449"><a href="#cb18-449" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb18-450"><a href="#cb18-450" aria-hidden="true" tabindex="-1"></a>display(results_cust.tail(<span class="dv">4</span>))</span>
<span id="cb18-451"><a href="#cb18-451" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-452"><a href="#cb18-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-453"><a href="#cb18-453" aria-hidden="true" tabindex="-1"></a><span class="al">![A small slice of the first tree in the forest](images/cust_rf_tree.png)</span>{#fig-static-image2}</span>
<span id="cb18-454"><a href="#cb18-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-455"><a href="#cb18-455" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">br</span><span class="dt">&gt;</span> </span>
<span id="cb18-456"><a href="#cb18-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-457"><a href="#cb18-457" aria-hidden="true" tabindex="-1"></a>The second model is the recursive $Sales$ one. This setup does _not_ change how the model is trained, since the training dataset includes the actual customers and lags. The fitted model processes the data row by row, allowing it to be used in any way that we deem fit.</span>
<span id="cb18-458"><a href="#cb18-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-461"><a href="#cb18-461" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb18-462"><a href="#cb18-462" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb18-463"><a href="#cb18-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-464"><a href="#cb18-464" aria-hidden="true" tabindex="-1"></a>display(results_sales.head(<span class="dv">4</span>))</span>
<span id="cb18-465"><a href="#cb18-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-466"><a href="#cb18-466" aria-hidden="true" tabindex="-1"></a>customers_best_params_rf <span class="op">=</span> pd.read_csv(<span class="st">"../outputs/customers_recursive_randomforest_grid_small.csv"</span>).iloc[<span class="dv">2</span>, <span class="dv">0</span>:<span class="dv">4</span>].to_dict()</span>
<span id="cb18-467"><a href="#cb18-467" aria-hidden="true" tabindex="-1"></a>sales_best_params_rf <span class="op">=</span> pd.read_csv(<span class="st">"../outputs/sales_recursive_randomforest_grid_small.csv"</span>).iloc[<span class="dv">2</span>, <span class="dv">0</span>:<span class="dv">4</span>].to_dict()</span>
<span id="cb18-468"><a href="#cb18-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-469"><a href="#cb18-469" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> params <span class="kw">in</span> (customers_best_params_rf, sales_best_params_rf):</span>
<span id="cb18-470"><a href="#cb18-470" aria-hidden="true" tabindex="-1"></a>    params[<span class="st">"max_depth"</span>] <span class="op">=</span> <span class="bu">int</span>(params[<span class="st">"max_depth"</span>])</span>
<span id="cb18-471"><a href="#cb18-471" aria-hidden="true" tabindex="-1"></a>    params[<span class="st">"max_features"</span>] <span class="op">=</span> <span class="bu">float</span>(params[<span class="st">"max_features"</span>])</span>
<span id="cb18-472"><a href="#cb18-472" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-473"><a href="#cb18-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-474"><a href="#cb18-474" aria-hidden="true" tabindex="-1"></a>It is important to note the gap between the best naive error $\text{RMSPE}_{naive}^{val} = 0.1431$ and the performance of the model which incorporates customers and time variables, with $\text{RMSPE}_{recur}^{val} = 0.0913$.</span>
<span id="cb18-475"><a href="#cb18-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-476"><a href="#cb18-476" aria-hidden="true" tabindex="-1"></a>The final models used for the modeling have these hyperparameters (we chose the 3rd sales model from the table, as it was less memory-heavy):</span>
<span id="cb18-477"><a href="#cb18-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-480"><a href="#cb18-480" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb18-481"><a href="#cb18-481" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-482"><a href="#cb18-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-483"><a href="#cb18-483" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> recursive_predict_sales_only(model_sales, train_data, test_data, sales_feats):</span>
<span id="cb18-484"><a href="#cb18-484" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-485"><a href="#cb18-485" aria-hidden="true" tabindex="-1"></a>    working_df <span class="op">=</span> test_data.copy().sort_values([<span class="st">"Date"</span>, <span class="st">"Store"</span>])</span>
<span id="cb18-486"><a href="#cb18-486" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-487"><a href="#cb18-487" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Setup History</span></span>
<span id="cb18-488"><a href="#cb18-488" aria-hidden="true" tabindex="-1"></a>    req_cols <span class="op">=</span> <span class="bu">list</span>(<span class="bu">set</span>(sales_feats <span class="op">+</span> [<span class="st">"Store"</span>, <span class="st">"Date"</span>, <span class="st">"Sales"</span>]))</span>
<span id="cb18-489"><a href="#cb18-489" aria-hidden="true" tabindex="-1"></a>    history <span class="op">=</span> train_data[req_cols].copy()</span>
<span id="cb18-490"><a href="#cb18-490" aria-hidden="true" tabindex="-1"></a>    history <span class="op">=</span> history.sort_values([<span class="st">"Store"</span>, <span class="st">"Date"</span>])</span>
<span id="cb18-491"><a href="#cb18-491" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-492"><a href="#cb18-492" aria-hidden="true" tabindex="-1"></a>    unique_dates <span class="op">=</span> working_df[<span class="st">"Date"</span>].unique()</span>
<span id="cb18-493"><a href="#cb18-493" aria-hidden="true" tabindex="-1"></a>    unique_dates <span class="op">=</span> np.sort(unique_dates)</span>
<span id="cb18-494"><a href="#cb18-494" aria-hidden="true" tabindex="-1"></a>    final_predictions <span class="op">=</span> []</span>
<span id="cb18-495"><a href="#cb18-495" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-496"><a href="#cb18-496" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> current_date <span class="kw">in</span> unique_dates:</span>
<span id="cb18-497"><a href="#cb18-497" aria-hidden="true" tabindex="-1"></a>        todays_slice <span class="op">=</span> working_df[working_df[<span class="st">"Date"</span>] <span class="op">==</span> current_date].copy()</span>
<span id="cb18-498"><a href="#cb18-498" aria-hidden="true" tabindex="-1"></a>        active_stores <span class="op">=</span> todays_slice[<span class="st">"Store"</span>].unique()</span>
<span id="cb18-499"><a href="#cb18-499" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-500"><a href="#cb18-500" aria-hidden="true" tabindex="-1"></a>        recent_history <span class="op">=</span> history[</span>
<span id="cb18-501"><a href="#cb18-501" aria-hidden="true" tabindex="-1"></a>            (history[<span class="st">"Store"</span>].isin(active_stores)) <span class="op">&amp;</span> </span>
<span id="cb18-502"><a href="#cb18-502" aria-hidden="true" tabindex="-1"></a>            (history[<span class="st">"Date"</span>] <span class="op">&gt;=</span> current_date <span class="op">-</span> pd.Timedelta(days<span class="op">=</span><span class="dv">8</span>)) <span class="op">&amp;</span></span>
<span id="cb18-503"><a href="#cb18-503" aria-hidden="true" tabindex="-1"></a>            (history[<span class="st">"Date"</span>] <span class="op">&lt;</span> current_date)</span>
<span id="cb18-504"><a href="#cb18-504" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb18-505"><a href="#cb18-505" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-506"><a href="#cb18-506" aria-hidden="true" tabindex="-1"></a>        calc_df <span class="op">=</span> pd.concat([recent_history, todays_slice], axis<span class="op">=</span><span class="dv">0</span>, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-507"><a href="#cb18-507" aria-hidden="true" tabindex="-1"></a>        calc_df <span class="op">=</span> calc_df.sort_values([<span class="st">"Store"</span>, <span class="st">"Date"</span>])</span>
<span id="cb18-508"><a href="#cb18-508" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-509"><a href="#cb18-509" aria-hidden="true" tabindex="-1"></a>        calc_df[<span class="st">"SalesLag1"</span>] <span class="op">=</span> calc_df.groupby(<span class="st">"Store"</span>)[<span class="st">"Sales"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb18-510"><a href="#cb18-510" aria-hidden="true" tabindex="-1"></a>        calc_df[<span class="st">"SalesLag7"</span>] <span class="op">=</span> calc_df.groupby(<span class="st">"Store"</span>)[<span class="st">"Sales"</span>].shift(<span class="dv">7</span>)</span>
<span id="cb18-511"><a href="#cb18-511" aria-hidden="true" tabindex="-1"></a>        calc_df[<span class="st">"RollingMean7"</span>] <span class="op">=</span> calc_df.groupby(<span class="st">"Store"</span>)[<span class="st">"Sales"</span>].rolling(<span class="dv">7</span>).mean().shift(<span class="dv">1</span>).reset_index(level<span class="op">=</span><span class="dv">0</span>, drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-512"><a href="#cb18-512" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-513"><a href="#cb18-513" aria-hidden="true" tabindex="-1"></a>        X_today <span class="op">=</span> calc_df[calc_df[<span class="st">"Date"</span>] <span class="op">==</span> current_date].copy()</span>
<span id="cb18-514"><a href="#cb18-514" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-515"><a href="#cb18-515" aria-hidden="true" tabindex="-1"></a>        X_today[<span class="st">"SalesLag1Available"</span>] <span class="op">=</span> <span class="op">~</span>X_today[<span class="st">"SalesLag1"</span>].isna() <span class="op">*</span> <span class="dv">1</span></span>
<span id="cb18-516"><a href="#cb18-516" aria-hidden="true" tabindex="-1"></a>        X_today[<span class="st">"SalesLag7Available"</span>] <span class="op">=</span> <span class="op">~</span>X_today[<span class="st">"SalesLag7"</span>].isna() <span class="op">*</span> <span class="dv">1</span></span>
<span id="cb18-517"><a href="#cb18-517" aria-hidden="true" tabindex="-1"></a>        X_today[<span class="st">"RollingMean7Available"</span>] <span class="op">=</span> <span class="op">~</span>X_today[<span class="st">"RollingMean7"</span>].isna() <span class="op">*</span> <span class="dv">1</span></span>
<span id="cb18-518"><a href="#cb18-518" aria-hidden="true" tabindex="-1"></a>        X_today <span class="op">=</span> X_today.fillna(<span class="dv">0</span>)</span>
<span id="cb18-519"><a href="#cb18-519" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-520"><a href="#cb18-520" aria-hidden="true" tabindex="-1"></a>        <span class="co"># calculate todays values</span></span>
<span id="cb18-521"><a href="#cb18-521" aria-hidden="true" tabindex="-1"></a>        X_today_feats <span class="op">=</span> X_today[sales_feats]</span>
<span id="cb18-522"><a href="#cb18-522" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-523"><a href="#cb18-523" aria-hidden="true" tabindex="-1"></a>        sales_preds <span class="op">=</span> model_sales.predict(X_today_feats)</span>
<span id="cb18-524"><a href="#cb18-524" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-525"><a href="#cb18-525" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">"Open"</span> <span class="kw">in</span> X_today.columns:</span>
<span id="cb18-526"><a href="#cb18-526" aria-hidden="true" tabindex="-1"></a>            sales_preds[X_today[<span class="st">"Open"</span>] <span class="op">==</span> <span class="dv">0</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb18-527"><a href="#cb18-527" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-528"><a href="#cb18-528" aria-hidden="true" tabindex="-1"></a>        <span class="co"># update</span></span>
<span id="cb18-529"><a href="#cb18-529" aria-hidden="true" tabindex="-1"></a>        X_today_result <span class="op">=</span> X_today.copy()</span>
<span id="cb18-530"><a href="#cb18-530" aria-hidden="true" tabindex="-1"></a>        X_today_result[<span class="st">"Sales"</span>] <span class="op">=</span> sales_preds</span>
<span id="cb18-531"><a href="#cb18-531" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-532"><a href="#cb18-532" aria-hidden="true" tabindex="-1"></a>        update_packet <span class="op">=</span> X_today_result[req_cols]</span>
<span id="cb18-533"><a href="#cb18-533" aria-hidden="true" tabindex="-1"></a>        history <span class="op">=</span> pd.concat([history, update_packet], axis<span class="op">=</span><span class="dv">0</span>, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-534"><a href="#cb18-534" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-535"><a href="#cb18-535" aria-hidden="true" tabindex="-1"></a>        final_predictions.append(X_today_result[[<span class="st">"Store"</span>, <span class="st">"Date"</span>, <span class="st">"Sales"</span>]])</span>
<span id="cb18-536"><a href="#cb18-536" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-537"><a href="#cb18-537" aria-hidden="true" tabindex="-1"></a>    final_df <span class="op">=</span> pd.concat(final_predictions, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb18-538"><a href="#cb18-538" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> final_df</span>
<span id="cb18-539"><a href="#cb18-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-540"><a href="#cb18-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-541"><a href="#cb18-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-542"><a href="#cb18-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-543"><a href="#cb18-543" aria-hidden="true" tabindex="-1"></a>recursive_train_set <span class="op">=</span> train_set.copy()</span>
<span id="cb18-544"><a href="#cb18-544" aria-hidden="true" tabindex="-1"></a>recursive_validation_set <span class="op">=</span> validation_set.copy()</span>
<span id="cb18-545"><a href="#cb18-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-546"><a href="#cb18-546" aria-hidden="true" tabindex="-1"></a>recursive_training_df <span class="op">=</span> pd.concat([recursive_train_set, </span>
<span id="cb18-547"><a href="#cb18-547" aria-hidden="true" tabindex="-1"></a>                                   recursive_validation_set], axis <span class="op">=</span> <span class="dv">0</span>).sort_values([<span class="st">"Store"</span>, <span class="st">"Date"</span>])</span>
<span id="cb18-548"><a href="#cb18-548" aria-hidden="true" tabindex="-1"></a>recursive_test_df <span class="op">=</span> test_set.copy().sort_values([<span class="st">"Store"</span>, <span class="st">"Date"</span>])</span>
<span id="cb18-549"><a href="#cb18-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-550"><a href="#cb18-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-551"><a href="#cb18-551" aria-hidden="true" tabindex="-1"></a><span class="co"># This gets the best parameters based on the naive grid search for customers only</span></span>
<span id="cb18-552"><a href="#cb18-552" aria-hidden="true" tabindex="-1"></a>model_cust <span class="op">=</span> RandomForestRegressor(<span class="op">**</span>customers_best_params_rf, </span>
<span id="cb18-553"><a href="#cb18-553" aria-hidden="true" tabindex="-1"></a>                                   n_jobs<span class="op">=</span><span class="dv">4</span>, </span>
<span id="cb18-554"><a href="#cb18-554" aria-hidden="true" tabindex="-1"></a>                                   random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb18-555"><a href="#cb18-555" aria-hidden="true" tabindex="-1"></a>                                   verbose<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb18-556"><a href="#cb18-556" aria-hidden="true" tabindex="-1"></a>model_cust.fit(recursive_training_df.loc[recursive_training_df[<span class="st">"Open"</span>] <span class="op">==</span> <span class="dv">1</span>, cols_to_select_cust], </span>
<span id="cb18-557"><a href="#cb18-557" aria-hidden="true" tabindex="-1"></a>               recursive_training_df.loc[recursive_training_df[<span class="st">"Open"</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">"Customers"</span>])</span>
<span id="cb18-558"><a href="#cb18-558" aria-hidden="true" tabindex="-1"></a>gc.collect()</span>
<span id="cb18-559"><a href="#cb18-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-560"><a href="#cb18-560" aria-hidden="true" tabindex="-1"></a><span class="co"># This gets the best parameters with actual sales values</span></span>
<span id="cb18-561"><a href="#cb18-561" aria-hidden="true" tabindex="-1"></a>model_sales <span class="op">=</span> RandomForestRegressor(<span class="op">**</span>sales_best_params_rf, </span>
<span id="cb18-562"><a href="#cb18-562" aria-hidden="true" tabindex="-1"></a>                                    n_jobs<span class="op">=</span><span class="dv">4</span>, </span>
<span id="cb18-563"><a href="#cb18-563" aria-hidden="true" tabindex="-1"></a>                                    random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb18-564"><a href="#cb18-564" aria-hidden="true" tabindex="-1"></a>                                    verbose<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb18-565"><a href="#cb18-565" aria-hidden="true" tabindex="-1"></a>model_sales.fit(recursive_training_df.loc[recursive_training_df[<span class="st">"Open"</span>] <span class="op">==</span> <span class="dv">1</span>, cols_to_select_sales], </span>
<span id="cb18-566"><a href="#cb18-566" aria-hidden="true" tabindex="-1"></a>                recursive_training_df.loc[recursive_training_df[<span class="st">"Open"</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">"Sales"</span>])</span>
<span id="cb18-567"><a href="#cb18-567" aria-hidden="true" tabindex="-1"></a>gc.collect()</span>
<span id="cb18-568"><a href="#cb18-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-569"><a href="#cb18-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-570"><a href="#cb18-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-571"><a href="#cb18-571" aria-hidden="true" tabindex="-1"></a>test_cust_preds <span class="op">=</span> model_cust.predict(recursive_test_df.loc[recursive_test_df[<span class="st">"Open"</span>] <span class="op">==</span> <span class="dv">1</span>, cols_to_select_cust])</span>
<span id="cb18-572"><a href="#cb18-572" aria-hidden="true" tabindex="-1"></a>test_cust_rmspe_open <span class="op">=</span> rmspe(recursive_test_df.loc[recursive_test_df[<span class="st">"Open"</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">"Customers"</span>], test_cust_preds)</span>
<span id="cb18-573"><a href="#cb18-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-574"><a href="#cb18-574" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Customers only, open stores RMSPE is: </span><span class="sc">{</span>test_cust_rmspe_open<span class="sc">:.4f}</span><span class="ss">."</span>)</span>
<span id="cb18-575"><a href="#cb18-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-576"><a href="#cb18-576" aria-hidden="true" tabindex="-1"></a>recursive_test_df.loc[recursive_test_df[<span class="st">"Open"</span>] <span class="op">==</span> <span class="dv">0</span>, <span class="st">"Customers"</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb18-577"><a href="#cb18-577" aria-hidden="true" tabindex="-1"></a>recursive_test_df.loc[recursive_test_df[<span class="st">"Open"</span>] <span class="op">==</span> <span class="dv">1</span>, <span class="st">"Customers"</span>] <span class="op">=</span> np.<span class="bu">round</span>(test_cust_preds)</span>
<span id="cb18-578"><a href="#cb18-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-579"><a href="#cb18-579" aria-hidden="true" tabindex="-1"></a>val_results <span class="op">=</span> recursive_predict_sales_only(</span>
<span id="cb18-580"><a href="#cb18-580" aria-hidden="true" tabindex="-1"></a>    model_sales, </span>
<span id="cb18-581"><a href="#cb18-581" aria-hidden="true" tabindex="-1"></a>    recursive_training_df,</span>
<span id="cb18-582"><a href="#cb18-582" aria-hidden="true" tabindex="-1"></a>    recursive_test_df,</span>
<span id="cb18-583"><a href="#cb18-583" aria-hidden="true" tabindex="-1"></a>    cols_to_select_sales</span>
<span id="cb18-584"><a href="#cb18-584" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-585"><a href="#cb18-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-586"><a href="#cb18-586" aria-hidden="true" tabindex="-1"></a>score <span class="op">=</span> rmspe(val_results.sort_values([<span class="st">"Store"</span>, <span class="st">"Date"</span>])[<span class="st">"Sales"</span>], recursive_test_df[<span class="st">"Sales"</span>])</span>
<span id="cb18-587"><a href="#cb18-587" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Final test sales RMSPE: </span><span class="sc">{</span>score<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb18-588"><a href="#cb18-588" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-589"><a href="#cb18-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-592"><a href="#cb18-592" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb18-593"><a href="#cb18-593" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb18-594"><a href="#cb18-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-595"><a href="#cb18-595" aria-hidden="true" tabindex="-1"></a>final_results_rf <span class="op">=</span> {k: [customers_best_params_rf[k], sales_best_params_rf[k]] <span class="cf">for</span> k <span class="kw">in</span> customers_best_params_rf}</span>
<span id="cb18-596"><a href="#cb18-596" aria-hidden="true" tabindex="-1"></a>final_results_rf <span class="op">=</span> pd.DataFrame(final_results_rf)</span>
<span id="cb18-597"><a href="#cb18-597" aria-hidden="true" tabindex="-1"></a>final_results_rf[<span class="st">"Test_RMSPE"</span>] <span class="op">=</span> [<span class="fl">0.1236</span>, <span class="fl">0.1406</span>]</span>
<span id="cb18-598"><a href="#cb18-598" aria-hidden="true" tabindex="-1"></a>final_results_rf[<span class="st">"Description"</span>] <span class="op">=</span> [<span class="st">"Customers only"</span>, <span class="st">"Final sales"</span>]</span>
<span id="cb18-599"><a href="#cb18-599" aria-hidden="true" tabindex="-1"></a>display(final_results_rf)</span>
<span id="cb18-600"><a href="#cb18-600" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-601"><a href="#cb18-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-602"><a href="#cb18-602" aria-hidden="true" tabindex="-1"></a>The final model is performing decently with an error of $\text{RMSPE}^{test}_{recur} = 0.1406$, which can be treated as a hypothetical baseline for the models that follow.</span>
<span id="cb18-603"><a href="#cb18-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-604"><a href="#cb18-604" aria-hidden="true" tabindex="-1"></a><span class="fu">## 3.3 Gradient Boosting - LightGBM</span></span>
<span id="cb18-605"><a href="#cb18-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-608"><a href="#cb18-608" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb18-609"><a href="#cb18-609" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb18-610"><a href="#cb18-610" aria-hidden="true" tabindex="-1"></a><span class="co">#| </span></span>
<span id="cb18-611"><a href="#cb18-611" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> grid_search_log(param_grid, model_type, x_train, y_train, x_val, y_val, n_jobs, verbose <span class="op">=</span> <span class="va">False</span>):</span>
<span id="cb18-612"><a href="#cb18-612" aria-hidden="true" tabindex="-1"></a>    keys, values <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>param_grid.items())</span>
<span id="cb18-613"><a href="#cb18-613" aria-hidden="true" tabindex="-1"></a>    param_combinations <span class="op">=</span> [<span class="bu">dict</span>(<span class="bu">zip</span>(keys, v)) <span class="cf">for</span> v <span class="kw">in</span> itertools.product(<span class="op">*</span>values)]</span>
<span id="cb18-614"><a href="#cb18-614" aria-hidden="true" tabindex="-1"></a>    results_data <span class="op">=</span> []</span>
<span id="cb18-615"><a href="#cb18-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-616"><a href="#cb18-616" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, params <span class="kw">in</span> <span class="bu">enumerate</span>(param_combinations):</span>
<span id="cb18-617"><a href="#cb18-617" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> model_type(</span>
<span id="cb18-618"><a href="#cb18-618" aria-hidden="true" tabindex="-1"></a>            <span class="op">**</span>params,</span>
<span id="cb18-619"><a href="#cb18-619" aria-hidden="true" tabindex="-1"></a>            random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb18-620"><a href="#cb18-620" aria-hidden="true" tabindex="-1"></a>            n_jobs<span class="op">=</span>n_jobs,</span>
<span id="cb18-621"><a href="#cb18-621" aria-hidden="true" tabindex="-1"></a>            verbose<span class="op">=</span><span class="dv">0</span></span>
<span id="cb18-622"><a href="#cb18-622" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb18-623"><a href="#cb18-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-624"><a href="#cb18-624" aria-hidden="true" tabindex="-1"></a>        model.fit(x_train, y_train)</span>
<span id="cb18-625"><a href="#cb18-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-626"><a href="#cb18-626" aria-hidden="true" tabindex="-1"></a>        y_train_predicted <span class="op">=</span> model.predict(x_train)</span>
<span id="cb18-627"><a href="#cb18-627" aria-hidden="true" tabindex="-1"></a>        y_val_predicted <span class="op">=</span> model.predict(x_val)</span>
<span id="cb18-628"><a href="#cb18-628" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-629"><a href="#cb18-629" aria-hidden="true" tabindex="-1"></a>        mse_train <span class="op">=</span> mean_squared_error(y_train, y_train_predicted)</span>
<span id="cb18-630"><a href="#cb18-630" aria-hidden="true" tabindex="-1"></a>        rmse_train <span class="op">=</span> mse_train <span class="op">**</span> <span class="fl">0.5</span></span>
<span id="cb18-631"><a href="#cb18-631" aria-hidden="true" tabindex="-1"></a>        r2_train <span class="op">=</span> r2_score(y_train, y_train_predicted)</span>
<span id="cb18-632"><a href="#cb18-632" aria-hidden="true" tabindex="-1"></a>        rmspe_train <span class="op">=</span> rmspe(np.expm1(y_train), np.expm1(y_train_predicted))</span>
<span id="cb18-633"><a href="#cb18-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-634"><a href="#cb18-634" aria-hidden="true" tabindex="-1"></a>        mse_val <span class="op">=</span> mean_squared_error(y_val, y_val_predicted)</span>
<span id="cb18-635"><a href="#cb18-635" aria-hidden="true" tabindex="-1"></a>        rmse_val <span class="op">=</span> mse_val <span class="op">**</span> <span class="fl">0.5</span></span>
<span id="cb18-636"><a href="#cb18-636" aria-hidden="true" tabindex="-1"></a>        r2_val <span class="op">=</span> r2_score(y_val, y_val_predicted)</span>
<span id="cb18-637"><a href="#cb18-637" aria-hidden="true" tabindex="-1"></a>        rmspe_val <span class="op">=</span> rmspe(np.expm1(y_val), np.expm1(y_val_predicted))</span>
<span id="cb18-638"><a href="#cb18-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-639"><a href="#cb18-639" aria-hidden="true" tabindex="-1"></a>        results_entry <span class="op">=</span> params.copy()</span>
<span id="cb18-640"><a href="#cb18-640" aria-hidden="true" tabindex="-1"></a>        results_entry[<span class="st">"Train_RMSPE"</span>] <span class="op">=</span> rmspe_train</span>
<span id="cb18-641"><a href="#cb18-641" aria-hidden="true" tabindex="-1"></a>        results_entry[<span class="st">"Val_RMSPE"</span>] <span class="op">=</span> rmspe_val</span>
<span id="cb18-642"><a href="#cb18-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-643"><a href="#cb18-643" aria-hidden="true" tabindex="-1"></a>        results_data.append(results_entry)</span>
<span id="cb18-644"><a href="#cb18-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-645"><a href="#cb18-645" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> verbose:</span>
<span id="cb18-646"><a href="#cb18-646" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"==== TRAINING ==== (</span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(param_combinations)<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb18-647"><a href="#cb18-647" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Train RMSE: </span><span class="sc">{</span>rmse_train<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb18-648"><a href="#cb18-648" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Train R²: </span><span class="sc">{</span>r2_train<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb18-649"><a href="#cb18-649" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Train RMSPE: </span><span class="sc">{</span>rmspe_train<span class="sc">:.4f}</span><span class="ss"> (</span><span class="sc">{</span>rmspe_train<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb18-650"><a href="#cb18-650" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"==== TRAINING ===="</span>)</span>
<span id="cb18-651"><a href="#cb18-651" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>()</span>
<span id="cb18-652"><a href="#cb18-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-653"><a href="#cb18-653" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"==== VALIDATION ==== (</span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(param_combinations)<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb18-654"><a href="#cb18-654" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Validation RMSE: </span><span class="sc">{</span>rmse_val<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb18-655"><a href="#cb18-655" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Validation R²: </span><span class="sc">{</span>r2_val<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb18-656"><a href="#cb18-656" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Validation RMSPE: </span><span class="sc">{</span>rmspe_val<span class="sc">:.4f}</span><span class="ss"> (</span><span class="sc">{</span>rmspe_val<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb18-657"><a href="#cb18-657" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"==== VALIDATION ===="</span>)</span>
<span id="cb18-658"><a href="#cb18-658" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb18-659"><a href="#cb18-659" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"(</span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(param_combinations)<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb18-660"><a href="#cb18-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-661"><a href="#cb18-661" aria-hidden="true" tabindex="-1"></a>    results_df <span class="op">=</span> pd.DataFrame(results_data)</span>
<span id="cb18-662"><a href="#cb18-662" aria-hidden="true" tabindex="-1"></a>    results_df <span class="op">=</span> results_df.sort_values(by<span class="op">=</span><span class="st">"Val_RMSPE"</span>, ascending<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-663"><a href="#cb18-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-664"><a href="#cb18-664" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> verbose:</span>
<span id="cb18-665"><a href="#cb18-665" aria-hidden="true" tabindex="-1"></a>        display(results_df.head(<span class="dv">5</span>))</span>
<span id="cb18-666"><a href="#cb18-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-667"><a href="#cb18-667" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results_df</span>
<span id="cb18-668"><a href="#cb18-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-669"><a href="#cb18-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-670"><a href="#cb18-670" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> recursive_predict_sales_only_log(model_sales, train_data, test_data, sales_feats):</span>
<span id="cb18-671"><a href="#cb18-671" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-672"><a href="#cb18-672" aria-hidden="true" tabindex="-1"></a>    working_df <span class="op">=</span> test_data.copy().sort_values([<span class="st">"Date"</span>, <span class="st">"Store"</span>])</span>
<span id="cb18-673"><a href="#cb18-673" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-674"><a href="#cb18-674" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Setup History</span></span>
<span id="cb18-675"><a href="#cb18-675" aria-hidden="true" tabindex="-1"></a>    req_cols <span class="op">=</span> <span class="bu">list</span>(<span class="bu">set</span>(sales_feats <span class="op">+</span> [<span class="st">"Store"</span>, <span class="st">"Date"</span>, <span class="st">"Sales"</span>])) <span class="co"># Ensure Open is here</span></span>
<span id="cb18-676"><a href="#cb18-676" aria-hidden="true" tabindex="-1"></a>    history <span class="op">=</span> train_data[req_cols].copy()</span>
<span id="cb18-677"><a href="#cb18-677" aria-hidden="true" tabindex="-1"></a>    history <span class="op">=</span> history.sort_values([<span class="st">"Store"</span>, <span class="st">"Date"</span>])</span>
<span id="cb18-678"><a href="#cb18-678" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-679"><a href="#cb18-679" aria-hidden="true" tabindex="-1"></a>    unique_dates <span class="op">=</span> working_df[<span class="st">"Date"</span>].unique()</span>
<span id="cb18-680"><a href="#cb18-680" aria-hidden="true" tabindex="-1"></a>    unique_dates <span class="op">=</span> np.sort(unique_dates)</span>
<span id="cb18-681"><a href="#cb18-681" aria-hidden="true" tabindex="-1"></a>    final_predictions <span class="op">=</span> []</span>
<span id="cb18-682"><a href="#cb18-682" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-683"><a href="#cb18-683" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> current_date <span class="kw">in</span> unique_dates:</span>
<span id="cb18-684"><a href="#cb18-684" aria-hidden="true" tabindex="-1"></a>        todays_slice <span class="op">=</span> working_df[working_df[<span class="st">"Date"</span>] <span class="op">==</span> current_date].copy()</span>
<span id="cb18-685"><a href="#cb18-685" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-686"><a href="#cb18-686" aria-hidden="true" tabindex="-1"></a>        <span class="co"># --- A. CALCULATE LAGS (Unchanged) ---</span></span>
<span id="cb18-687"><a href="#cb18-687" aria-hidden="true" tabindex="-1"></a>        active_stores <span class="op">=</span> todays_slice[<span class="st">"Store"</span>].unique()</span>
<span id="cb18-688"><a href="#cb18-688" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-689"><a href="#cb18-689" aria-hidden="true" tabindex="-1"></a>        recent_history <span class="op">=</span> history[</span>
<span id="cb18-690"><a href="#cb18-690" aria-hidden="true" tabindex="-1"></a>            (history[<span class="st">"Store"</span>].isin(active_stores)) <span class="op">&amp;</span> </span>
<span id="cb18-691"><a href="#cb18-691" aria-hidden="true" tabindex="-1"></a>            (history[<span class="st">"Date"</span>] <span class="op">&gt;=</span> current_date <span class="op">-</span> pd.Timedelta(days<span class="op">=</span><span class="dv">15</span>)) <span class="op">&amp;</span></span>
<span id="cb18-692"><a href="#cb18-692" aria-hidden="true" tabindex="-1"></a>            (history[<span class="st">"Date"</span>] <span class="op">&lt;</span> current_date)</span>
<span id="cb18-693"><a href="#cb18-693" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb18-694"><a href="#cb18-694" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-695"><a href="#cb18-695" aria-hidden="true" tabindex="-1"></a>        calc_df <span class="op">=</span> pd.concat([recent_history, todays_slice], axis<span class="op">=</span><span class="dv">0</span>, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-696"><a href="#cb18-696" aria-hidden="true" tabindex="-1"></a>        calc_df <span class="op">=</span> calc_df.sort_values([<span class="st">"Store"</span>, <span class="st">"Date"</span>])</span>
<span id="cb18-697"><a href="#cb18-697" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-698"><a href="#cb18-698" aria-hidden="true" tabindex="-1"></a>        calc_df[<span class="st">"SalesLag1"</span>] <span class="op">=</span> calc_df.groupby(<span class="st">"Store"</span>)[<span class="st">"Sales"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb18-699"><a href="#cb18-699" aria-hidden="true" tabindex="-1"></a>        calc_df[<span class="st">"SalesLag7"</span>] <span class="op">=</span> calc_df.groupby(<span class="st">"Store"</span>)[<span class="st">"Sales"</span>].shift(<span class="dv">7</span>)</span>
<span id="cb18-700"><a href="#cb18-700" aria-hidden="true" tabindex="-1"></a>        calc_df[<span class="st">"RollingMean7"</span>] <span class="op">=</span> calc_df.groupby(<span class="st">"Store"</span>)[<span class="st">"Sales"</span>].rolling(<span class="dv">7</span>).mean().shift(<span class="dv">1</span>).reset_index(level<span class="op">=</span><span class="dv">0</span>, drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-701"><a href="#cb18-701" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-702"><a href="#cb18-702" aria-hidden="true" tabindex="-1"></a>        X_today <span class="op">=</span> calc_df[calc_df[<span class="st">"Date"</span>] <span class="op">==</span> current_date].copy()</span>
<span id="cb18-703"><a href="#cb18-703" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-704"><a href="#cb18-704" aria-hidden="true" tabindex="-1"></a>        X_today[<span class="st">"SalesLag1Available"</span>] <span class="op">=</span> <span class="op">~</span>X_today[<span class="st">"SalesLag1"</span>].isna() <span class="op">*</span> <span class="dv">1</span></span>
<span id="cb18-705"><a href="#cb18-705" aria-hidden="true" tabindex="-1"></a>        X_today[<span class="st">"SalesLag7Available"</span>] <span class="op">=</span> <span class="op">~</span>X_today[<span class="st">"SalesLag7"</span>].isna() <span class="op">*</span> <span class="dv">1</span></span>
<span id="cb18-706"><a href="#cb18-706" aria-hidden="true" tabindex="-1"></a>        X_today[<span class="st">"RollingMean7Available"</span>] <span class="op">=</span> <span class="op">~</span>X_today[<span class="st">"RollingMean7"</span>].isna() <span class="op">*</span> <span class="dv">1</span></span>
<span id="cb18-707"><a href="#cb18-707" aria-hidden="true" tabindex="-1"></a>        X_today <span class="op">=</span> X_today.fillna(<span class="dv">0</span>)</span>
<span id="cb18-708"><a href="#cb18-708" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-709"><a href="#cb18-709" aria-hidden="true" tabindex="-1"></a>        <span class="co"># --- B. PREDICT SALES ---</span></span>
<span id="cb18-710"><a href="#cb18-710" aria-hidden="true" tabindex="-1"></a>        X_today_feats <span class="op">=</span> X_today[sales_feats]</span>
<span id="cb18-711"><a href="#cb18-711" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-712"><a href="#cb18-712" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 1. Get Log Predictions</span></span>
<span id="cb18-713"><a href="#cb18-713" aria-hidden="true" tabindex="-1"></a>        sales_preds <span class="op">=</span> np.expm1(model_sales.predict(X_today_feats))</span>
<span id="cb18-714"><a href="#cb18-714" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-715"><a href="#cb18-715" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">"Open"</span> <span class="kw">in</span> X_today.columns:</span>
<span id="cb18-716"><a href="#cb18-716" aria-hidden="true" tabindex="-1"></a>             sales_preds[X_today[<span class="st">"Open"</span>] <span class="op">==</span> <span class="dv">0</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb18-717"><a href="#cb18-717" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-718"><a href="#cb18-718" aria-hidden="true" tabindex="-1"></a>        <span class="co"># --- C. UPDATE HISTORY ---</span></span>
<span id="cb18-719"><a href="#cb18-719" aria-hidden="true" tabindex="-1"></a>        X_today_result <span class="op">=</span> X_today.copy()</span>
<span id="cb18-720"><a href="#cb18-720" aria-hidden="true" tabindex="-1"></a>        X_today_result[<span class="st">"Sales"</span>] <span class="op">=</span> sales_preds <span class="co"># Now saving REAL numbers</span></span>
<span id="cb18-721"><a href="#cb18-721" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-722"><a href="#cb18-722" aria-hidden="true" tabindex="-1"></a>        update_packet <span class="op">=</span> X_today_result[req_cols]</span>
<span id="cb18-723"><a href="#cb18-723" aria-hidden="true" tabindex="-1"></a>        history <span class="op">=</span> pd.concat([history, update_packet], axis<span class="op">=</span><span class="dv">0</span>, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-724"><a href="#cb18-724" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-725"><a href="#cb18-725" aria-hidden="true" tabindex="-1"></a>        final_predictions.append(X_today_result[[<span class="st">"Store"</span>, <span class="st">"Date"</span>, <span class="st">"Sales"</span>]])</span>
<span id="cb18-726"><a href="#cb18-726" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-727"><a href="#cb18-727" aria-hidden="true" tabindex="-1"></a>    final_df <span class="op">=</span> pd.concat(final_predictions, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb18-728"><a href="#cb18-728" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> final_df</span>
<span id="cb18-729"><a href="#cb18-729" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-730"><a href="#cb18-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-731"><a href="#cb18-731" aria-hidden="true" tabindex="-1"></a>Gradient boosting algorithms offer a modern and highly effective way to utilize decision trees in machine learning. They are significantly more lightweight compared to random forests, much faster and tend to deliver much better results compared to random forests. The most popular algorithms (for regression) are __XGBoost__ and __LightGBM__.</span>
<span id="cb18-732"><a href="#cb18-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-733"><a href="#cb18-733" aria-hidden="true" tabindex="-1"></a>We decided to use the LightGBM due to it's higher efficiency (mainly less memory usage).</span>
<span id="cb18-736"><a href="#cb18-736" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb18-737"><a href="#cb18-737" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-738"><a href="#cb18-738" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb18-739"><a href="#cb18-739" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb18-740"><a href="#cb18-740" aria-hidden="true" tabindex="-1"></a>lgbm_param_grid_cust <span class="op">=</span> {</span>
<span id="cb18-741"><a href="#cb18-741" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_estimators"</span>: [<span class="dv">500</span>, <span class="dv">1000</span>],</span>
<span id="cb18-742"><a href="#cb18-742" aria-hidden="true" tabindex="-1"></a>    <span class="st">"learning_rate"</span>: [<span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>],</span>
<span id="cb18-743"><a href="#cb18-743" aria-hidden="true" tabindex="-1"></a>    <span class="st">"num_leaves"</span>: [<span class="dv">15</span>, <span class="dv">31</span>, <span class="dv">63</span>],</span>
<span id="cb18-744"><a href="#cb18-744" aria-hidden="true" tabindex="-1"></a>    <span class="st">"subsample"</span>: [<span class="fl">0.6</span>, <span class="fl">0.8</span>, <span class="dv">1</span>],</span>
<span id="cb18-745"><a href="#cb18-745" aria-hidden="true" tabindex="-1"></a>    <span class="st">"subsample_freq"</span>: [<span class="dv">1</span>],</span>
<span id="cb18-746"><a href="#cb18-746" aria-hidden="true" tabindex="-1"></a>    <span class="st">"colsample_bytree"</span>: [<span class="fl">0.5</span>, <span class="fl">0.8</span>, <span class="dv">1</span>]</span>
<span id="cb18-747"><a href="#cb18-747" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-748"><a href="#cb18-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-749"><a href="#cb18-749" aria-hidden="true" tabindex="-1"></a>results_cust_lgb <span class="op">=</span> grid_search_log(param_grid<span class="op">=</span>lgbm_param_grid_cust,</span>
<span id="cb18-750"><a href="#cb18-750" aria-hidden="true" tabindex="-1"></a>                                   model_type<span class="op">=</span>lgb.LGBMRegressor,</span>
<span id="cb18-751"><a href="#cb18-751" aria-hidden="true" tabindex="-1"></a>                                   x_train<span class="op">=</span>x_train_cust,</span>
<span id="cb18-752"><a href="#cb18-752" aria-hidden="true" tabindex="-1"></a>                                   y_train<span class="op">=</span>np.log1p(y_train_cust),</span>
<span id="cb18-753"><a href="#cb18-753" aria-hidden="true" tabindex="-1"></a>                                   x_val<span class="op">=</span>x_val_cust,</span>
<span id="cb18-754"><a href="#cb18-754" aria-hidden="true" tabindex="-1"></a>                                   y_val<span class="op">=</span>np.log1p(y_val_cust),</span>
<span id="cb18-755"><a href="#cb18-755" aria-hidden="true" tabindex="-1"></a>                                   n_jobs<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb18-756"><a href="#cb18-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-757"><a href="#cb18-757" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-758"><a href="#cb18-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-759"><a href="#cb18-759" aria-hidden="true" tabindex="-1"></a>As we have seen in the visualization part, we decided to take a $\log{(x + 1)}$ of customers and sales, which helped with their skewness and centered them.</span>
<span id="cb18-760"><a href="#cb18-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-761"><a href="#cb18-761" aria-hidden="true" tabindex="-1"></a>The performance of the $Customer$ model on the validation set is comparable to that of the Random Forests. However, LightGBM model improved hugely on the training data, perhaps suggesting that now it would have the capacity to achieve strong results regardless of the seasonal positioning of the validation period.</span>
<span id="cb18-762"><a href="#cb18-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-765"><a href="#cb18-765" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb18-766"><a href="#cb18-766" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb18-767"><a href="#cb18-767" aria-hidden="true" tabindex="-1"></a>results_cust_lgb <span class="op">=</span> pd.read_csv(<span class="st">"../outputs/customers_recursive_lightgbm_grid.csv"</span>)</span>
<span id="cb18-768"><a href="#cb18-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-769"><a href="#cb18-769" aria-hidden="true" tabindex="-1"></a>results_cust_lgb.head(<span class="dv">4</span>)</span>
<span id="cb18-770"><a href="#cb18-770" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-771"><a href="#cb18-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-772"><a href="#cb18-772" aria-hidden="true" tabindex="-1"></a>Here are the results for the sales model, which show a significant improvement all around.</span>
<span id="cb18-773"><a href="#cb18-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-776"><a href="#cb18-776" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb18-777"><a href="#cb18-777" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb18-778"><a href="#cb18-778" aria-hidden="true" tabindex="-1"></a>results_cust_lgb <span class="op">=</span> pd.read_csv(<span class="st">"../outputs/sales_recursive_lightgbm_grid.csv"</span>)</span>
<span id="cb18-779"><a href="#cb18-779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-780"><a href="#cb18-780" aria-hidden="true" tabindex="-1"></a>results_cust_lgb.head(<span class="dv">4</span>)</span>
<span id="cb18-781"><a href="#cb18-781" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-782"><a href="#cb18-782" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-783"><a href="#cb18-783" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">br</span><span class="dt">&gt;</span></span>
<span id="cb18-784"><a href="#cb18-784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-785"><a href="#cb18-785" aria-hidden="true" tabindex="-1"></a><span class="al">![Feature importance for the customer model](images/feature_importance_customers)</span>{#fig-importance-cust}</span>
<span id="cb18-786"><a href="#cb18-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-787"><a href="#cb18-787" aria-hidden="true" tabindex="-1"></a><span class="al">![Feature importance for the sales model](images/feature_importance_sales)</span>{#fig-importance-sales}</span>
<span id="cb18-788"><a href="#cb18-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-789"><a href="#cb18-789" aria-hidden="true" tabindex="-1"></a>The final test results of our best models are shown below.</span>
<span id="cb18-792"><a href="#cb18-792" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb18-793"><a href="#cb18-793" aria-hidden="true" tabindex="-1"></a>customers_best_params_lgb <span class="op">=</span> pd.read_csv(<span class="st">"../outputs/customers_recursive_lightgbm_grid.csv"</span>).iloc[<span class="dv">0</span>, <span class="dv">0</span>:<span class="dv">6</span>].to_dict()</span>
<span id="cb18-794"><a href="#cb18-794" aria-hidden="true" tabindex="-1"></a>sales_best_params_lgb <span class="op">=</span> pd.read_csv(<span class="st">"../outputs/sales_recursive_lightgbm_grid.csv"</span>).iloc[<span class="dv">0</span>, <span class="dv">0</span>:<span class="dv">6</span>].to_dict()</span>
<span id="cb18-795"><a href="#cb18-795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-796"><a href="#cb18-796" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> params <span class="kw">in</span> (customers_best_params_lgb, sales_best_params_lgb):</span>
<span id="cb18-797"><a href="#cb18-797" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key <span class="kw">in</span> params.keys():</span>
<span id="cb18-798"><a href="#cb18-798" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> key <span class="kw">not</span> <span class="kw">in</span> (<span class="st">"learning_rate"</span>, <span class="st">"colsample_bytree"</span>, <span class="st">"subsample"</span>):</span>
<span id="cb18-799"><a href="#cb18-799" aria-hidden="true" tabindex="-1"></a>            params[key] <span class="op">=</span> <span class="bu">int</span>(params[key])</span>
<span id="cb18-800"><a href="#cb18-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-801"><a href="#cb18-801" aria-hidden="true" tabindex="-1"></a>final_results_lgb <span class="op">=</span> {k: [customers_best_params_lgb[k], sales_best_params_lgb[k]] <span class="cf">for</span> k <span class="kw">in</span> customers_best_params_lgb}</span>
<span id="cb18-802"><a href="#cb18-802" aria-hidden="true" tabindex="-1"></a>final_results_lgb <span class="op">=</span> pd.DataFrame(final_results_lgb)</span>
<span id="cb18-803"><a href="#cb18-803" aria-hidden="true" tabindex="-1"></a>final_results_lgb[<span class="st">"Test_RMSPE"</span>] <span class="op">=</span> [<span class="fl">0.1022</span>, <span class="fl">0.1235</span>]</span>
<span id="cb18-804"><a href="#cb18-804" aria-hidden="true" tabindex="-1"></a>final_results_lgb[<span class="st">"Description"</span>] <span class="op">=</span> [<span class="st">"Customers only"</span>, <span class="st">"Final sales"</span>]</span>
<span id="cb18-805"><a href="#cb18-805" aria-hidden="true" tabindex="-1"></a>display(final_results_lgb)</span>
<span id="cb18-806"><a href="#cb18-806" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-807"><a href="#cb18-807" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-808"><a href="#cb18-808" aria-hidden="true" tabindex="-1"></a><span class="fu">## 3.4 Neural Networks - classic MLP</span></span>
<span id="cb18-809"><a href="#cb18-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-810"><a href="#cb18-810" aria-hidden="true" tabindex="-1"></a>Neural networks are the final type of model we applied. They differ from decision trees, be it boosting or random forests, as they usually need a GPU to be trained (compared to our previous models, which used the processor).</span>
<span id="cb18-811"><a href="#cb18-811" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-812"><a href="#cb18-812" aria-hidden="true" tabindex="-1"></a>They are also very sensitive to the scale of input features. Because of this, we had to rebuild the entire dataset again, scaling the numerical variables while also one-hot encoding the categorical features.</span>
<span id="cb18-813"><a href="#cb18-813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-816"><a href="#cb18-816" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb18-817"><a href="#cb18-817" aria-hidden="true" tabindex="-1"></a>dataset_nn <span class="op">=</span> pd.read_pickle(<span class="st">"../train_clean.pkl"</span>)</span>
<span id="cb18-818"><a href="#cb18-818" aria-hidden="true" tabindex="-1"></a>dataset_nn <span class="op">=</span> dataset_nn.sort_values(by<span class="op">=</span>[<span class="st">"Store"</span>, <span class="st">"Date"</span>]).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-819"><a href="#cb18-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-820"><a href="#cb18-820" aria-hidden="true" tabindex="-1"></a><span class="co"># ===== CREATING LAGS AND ROLLING MEANS =====</span></span>
<span id="cb18-821"><a href="#cb18-821" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> warnings.catch_warnings():</span>
<span id="cb18-822"><a href="#cb18-822" aria-hidden="true" tabindex="-1"></a>    warnings.simplefilter(<span class="st">"ignore"</span>)</span>
<span id="cb18-823"><a href="#cb18-823" aria-hidden="true" tabindex="-1"></a>    dataset_nn[<span class="st">"SalesLag1"</span>] <span class="op">=</span> dataset_nn.groupby(<span class="st">"Store"</span>)[<span class="st">"Sales"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb18-824"><a href="#cb18-824" aria-hidden="true" tabindex="-1"></a>    dataset_nn[<span class="st">"SalesLag7"</span>] <span class="op">=</span> dataset_nn.groupby(<span class="st">"Store"</span>)[<span class="st">"Sales"</span>].shift(<span class="dv">7</span>)</span>
<span id="cb18-825"><a href="#cb18-825" aria-hidden="true" tabindex="-1"></a>    dataset_nn[<span class="st">"RollingMean7"</span>] <span class="op">=</span> dataset_nn.groupby(<span class="st">"Store"</span>)[<span class="st">"Sales"</span>].rolling(<span class="dv">7</span>).mean().shift(<span class="dv">1</span>).reset_index(level<span class="op">=</span><span class="dv">0</span>, drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-826"><a href="#cb18-826" aria-hidden="true" tabindex="-1"></a>    first_idx_per_store <span class="op">=</span> dataset_nn.groupby(<span class="st">"Store"</span>).head(<span class="dv">1</span>).index</span>
<span id="cb18-827"><a href="#cb18-827" aria-hidden="true" tabindex="-1"></a>    dataset_nn.loc[first_idx_per_store, <span class="st">"RollingMean7"</span>] <span class="op">=</span> <span class="bu">float</span>(<span class="st">"nan"</span>)</span>
<span id="cb18-828"><a href="#cb18-828" aria-hidden="true" tabindex="-1"></a>    dataset_nn[<span class="st">"SalesLag1Available"</span>] <span class="op">=</span> <span class="op">~</span>dataset_nn[<span class="st">"SalesLag1"</span>].isna() <span class="op">*</span> <span class="dv">1</span></span>
<span id="cb18-829"><a href="#cb18-829" aria-hidden="true" tabindex="-1"></a>    dataset_nn[<span class="st">"SalesLag7Available"</span>] <span class="op">=</span> <span class="op">~</span>dataset_nn[<span class="st">"SalesLag7"</span>].isna() <span class="op">*</span> <span class="dv">1</span></span>
<span id="cb18-830"><a href="#cb18-830" aria-hidden="true" tabindex="-1"></a>    dataset_nn[<span class="st">"RollingMean7Available"</span>] <span class="op">=</span> <span class="op">~</span>dataset_nn[<span class="st">"RollingMean7"</span>].isna() <span class="op">*</span> <span class="dv">1</span></span>
<span id="cb18-831"><a href="#cb18-831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-832"><a href="#cb18-832" aria-hidden="true" tabindex="-1"></a>    dataset_nn.loc[:, dataset_nn.isna().<span class="bu">sum</span>() <span class="op">!=</span> <span class="dv">0</span>] <span class="op">=</span> dataset_nn.loc[:, dataset_nn.isna().<span class="bu">sum</span>() <span class="op">!=</span> <span class="dv">0</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb18-833"><a href="#cb18-833" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-834"><a href="#cb18-834" aria-hidden="true" tabindex="-1"></a><span class="co"># ===== TRAIN, VALIDATION, </span><span class="al">TEST</span><span class="co"> SPLITTING =====</span></span>
<span id="cb18-835"><a href="#cb18-835" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-836"><a href="#cb18-836" aria-hidden="true" tabindex="-1"></a>days_amount <span class="op">=</span> (dataset_nn.Date.iloc[<span class="op">-</span><span class="dv">1</span>,] <span class="op">-</span> dataset_nn.Date.iloc[<span class="dv">0</span>,])</span>
<span id="cb18-837"><a href="#cb18-837" aria-hidden="true" tabindex="-1"></a>test_split_time <span class="op">=</span> dataset_nn.Date.iloc[<span class="op">-</span><span class="dv">1</span>,] <span class="op">-</span> pd.Timedelta(days<span class="op">=</span><span class="bu">int</span>(days_amount.days<span class="op">*</span><span class="fl">0.05</span> <span class="op">-</span> <span class="dv">1</span>))</span>
<span id="cb18-838"><a href="#cb18-838" aria-hidden="true" tabindex="-1"></a>validation_split_time <span class="op">=</span> dataset_nn.Date.iloc[<span class="op">-</span><span class="dv">1</span>,] <span class="op">-</span> pd.Timedelta(days<span class="op">=</span><span class="bu">int</span>(days_amount.days<span class="op">*</span><span class="fl">0.1</span> <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb18-839"><a href="#cb18-839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-840"><a href="#cb18-840" aria-hidden="true" tabindex="-1"></a>train_set_nn_clean <span class="op">=</span> dataset_nn[dataset_nn.Date <span class="op">&lt;</span> validation_split_time]</span>
<span id="cb18-841"><a href="#cb18-841" aria-hidden="true" tabindex="-1"></a>validation_set_nn_clean <span class="op">=</span> dataset_nn[(dataset_nn.Date <span class="op">&gt;=</span> validation_split_time) <span class="op">&amp;</span> (dataset_nn.Date <span class="op">&lt;</span> test_split_time)]</span>
<span id="cb18-842"><a href="#cb18-842" aria-hidden="true" tabindex="-1"></a>test_set_nn_clean <span class="op">=</span> dataset_nn[dataset_nn.Date <span class="op">&gt;=</span> test_split_time]</span>
<span id="cb18-843"><a href="#cb18-843" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-844"><a href="#cb18-844" aria-hidden="true" tabindex="-1"></a>embed_cols <span class="op">=</span> [<span class="st">"Store"</span>] </span>
<span id="cb18-845"><a href="#cb18-845" aria-hidden="true" tabindex="-1"></a>dummify_cols <span class="op">=</span> [<span class="st">"StateHoliday"</span>, <span class="st">"StoreType"</span>, <span class="st">"Assortment"</span>, <span class="st">"DayOfWeek"</span>] </span>
<span id="cb18-846"><a href="#cb18-846" aria-hidden="true" tabindex="-1"></a><span class="co"># num_cols have to be scaled (standardized to mean 0 and std of 1)</span></span>
<span id="cb18-847"><a href="#cb18-847" aria-hidden="true" tabindex="-1"></a>num_cols <span class="op">=</span> [</span>
<span id="cb18-848"><a href="#cb18-848" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SalesLag1"</span>, <span class="st">"SalesLag7"</span>, <span class="st">"RollingMean7"</span>, </span>
<span id="cb18-849"><a href="#cb18-849" aria-hidden="true" tabindex="-1"></a>    <span class="st">"LogCompetitionDistance"</span>, </span>
<span id="cb18-850"><a href="#cb18-850" aria-hidden="true" tabindex="-1"></a>    <span class="st">"CompetitionMonthsTotal"</span>, </span>
<span id="cb18-851"><a href="#cb18-851" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Promo2MonthsTotal"</span>,</span>
<span id="cb18-852"><a href="#cb18-852" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Year"</span>, <span class="st">"Month"</span>, <span class="st">"Week"</span></span>
<span id="cb18-853"><a href="#cb18-853" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb18-854"><a href="#cb18-854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-855"><a href="#cb18-855" aria-hidden="true" tabindex="-1"></a>binary_cols <span class="op">=</span> [</span>
<span id="cb18-856"><a href="#cb18-856" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Open"</span>, <span class="st">"Promo"</span>, <span class="st">"SchoolHoliday"</span>, <span class="st">"Promo2"</span>, <span class="st">"Promo2CurrentlyOn"</span>, <span class="st">"CompetitionMonthsKnown"</span>,</span>
<span id="cb18-857"><a href="#cb18-857" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SalesLag1Available"</span>, <span class="st">"SalesLag7Available"</span>, <span class="st">"RollingMean7Available"</span></span>
<span id="cb18-858"><a href="#cb18-858" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb18-859"><a href="#cb18-859" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-860"><a href="#cb18-860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-861"><a href="#cb18-861" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-862"><a href="#cb18-862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-863"><a href="#cb18-863" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-864"><a href="#cb18-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-865"><a href="#cb18-865" aria-hidden="true" tabindex="-1"></a><span class="co"># A ===== LOG TRANSFORMING =====</span></span>
<span id="cb18-866"><a href="#cb18-866" aria-hidden="true" tabindex="-1"></a>train_set_nn <span class="op">=</span> train_set_nn_clean.copy()</span>
<span id="cb18-867"><a href="#cb18-867" aria-hidden="true" tabindex="-1"></a>validation_set_nn <span class="op">=</span> validation_set_nn_clean.copy()</span>
<span id="cb18-868"><a href="#cb18-868" aria-hidden="true" tabindex="-1"></a>test_set_nn <span class="op">=</span> test_set_nn_clean.copy()</span>
<span id="cb18-869"><a href="#cb18-869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-870"><a href="#cb18-870" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> df_nn <span class="kw">in</span> (train_set_nn, validation_set_nn, test_set_nn):</span>
<span id="cb18-871"><a href="#cb18-871" aria-hidden="true" tabindex="-1"></a>    df_nn[<span class="st">"Sales_log"</span>] <span class="op">=</span> np.log1p(df_nn[<span class="st">"Sales"</span>])</span>
<span id="cb18-872"><a href="#cb18-872" aria-hidden="true" tabindex="-1"></a>    df_nn[<span class="st">"Customers_log"</span>] <span class="op">=</span> np.log1p(df_nn[<span class="st">"Customers"</span>])</span>
<span id="cb18-873"><a href="#cb18-873" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-874"><a href="#cb18-874" aria-hidden="true" tabindex="-1"></a><span class="co"># B ===== ONE HOT ENCODING =====</span></span>
<span id="cb18-875"><a href="#cb18-875" aria-hidden="true" tabindex="-1"></a>train_set_nn <span class="op">=</span> pd.get_dummies(train_set_nn, columns<span class="op">=</span>dummify_cols, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb18-876"><a href="#cb18-876" aria-hidden="true" tabindex="-1"></a>validation_set_nn <span class="op">=</span> pd.get_dummies(validation_set_nn, columns<span class="op">=</span>dummify_cols, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb18-877"><a href="#cb18-877" aria-hidden="true" tabindex="-1"></a>test_set_nn <span class="op">=</span> pd.get_dummies(test_set_nn, columns<span class="op">=</span>dummify_cols, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb18-878"><a href="#cb18-878" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-879"><a href="#cb18-879" aria-hidden="true" tabindex="-1"></a>train_cols <span class="op">=</span> train_set_nn.columns</span>
<span id="cb18-880"><a href="#cb18-880" aria-hidden="true" tabindex="-1"></a>validation_set_nn <span class="op">=</span> validation_set_nn.reindex(columns<span class="op">=</span>train_cols, fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb18-881"><a href="#cb18-881" aria-hidden="true" tabindex="-1"></a>test_set_nn <span class="op">=</span> test_set_nn.reindex(columns<span class="op">=</span>train_cols, fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb18-882"><a href="#cb18-882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-883"><a href="#cb18-883" aria-hidden="true" tabindex="-1"></a>new_one_hot_features <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> train_set_nn.columns <span class="cf">if</span> <span class="bu">any</span>(x <span class="kw">in</span> c <span class="cf">for</span> x <span class="kw">in</span> dummify_cols)]</span>
<span id="cb18-884"><a href="#cb18-884" aria-hidden="true" tabindex="-1"></a>all_binary_cols <span class="op">=</span> binary_cols <span class="op">+</span> new_one_hot_features</span>
<span id="cb18-885"><a href="#cb18-885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-886"><a href="#cb18-886" aria-hidden="true" tabindex="-1"></a><span class="co"># C ===== SCALING NUMERICAL VARIABLES =====</span></span>
<span id="cb18-887"><a href="#cb18-887" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb18-888"><a href="#cb18-888" aria-hidden="true" tabindex="-1"></a>cols_to_scale <span class="op">=</span> num_cols <span class="op">+</span> [<span class="st">"Customers_log"</span>]</span>
<span id="cb18-889"><a href="#cb18-889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-890"><a href="#cb18-890" aria-hidden="true" tabindex="-1"></a><span class="co"># Scale (Overwrites columns in place)</span></span>
<span id="cb18-891"><a href="#cb18-891" aria-hidden="true" tabindex="-1"></a>train_set_nn[cols_to_scale] <span class="op">=</span> scaler.fit_transform(train_set_nn[cols_to_scale])</span>
<span id="cb18-892"><a href="#cb18-892" aria-hidden="true" tabindex="-1"></a>validation_set_nn[cols_to_scale] <span class="op">=</span> scaler.transform(validation_set_nn[cols_to_scale])</span>
<span id="cb18-893"><a href="#cb18-893" aria-hidden="true" tabindex="-1"></a>test_set_nn[cols_to_scale] <span class="op">=</span> scaler.transform(test_set_nn[cols_to_scale])</span>
<span id="cb18-894"><a href="#cb18-894" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-895"><a href="#cb18-895" aria-hidden="true" tabindex="-1"></a><span class="co"># Save scaler stats for recursion later</span></span>
<span id="cb18-896"><a href="#cb18-896" aria-hidden="true" tabindex="-1"></a>cust_idx <span class="op">=</span> cols_to_scale.index(<span class="st">"Customers_log"</span>)</span>
<span id="cb18-897"><a href="#cb18-897" aria-hidden="true" tabindex="-1"></a>cust_mean <span class="op">=</span> scaler.mean_[cust_idx]</span>
<span id="cb18-898"><a href="#cb18-898" aria-hidden="true" tabindex="-1"></a>cust_scale <span class="op">=</span> scaler.scale_[cust_idx]</span>
<span id="cb18-899"><a href="#cb18-899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-900"><a href="#cb18-900" aria-hidden="true" tabindex="-1"></a>cust_input_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> cols_to_scale <span class="cf">if</span> c <span class="op">!=</span> <span class="st">"Customers_log"</span>] <span class="op">+</span> all_binary_cols</span>
<span id="cb18-901"><a href="#cb18-901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-902"><a href="#cb18-902" aria-hidden="true" tabindex="-1"></a><span class="co"># D ===== PREPARE DICTIONARY =====</span></span>
<span id="cb18-903"><a href="#cb18-903" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_inputs(df):</span>
<span id="cb18-904"><a href="#cb18-904" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> {</span>
<span id="cb18-905"><a href="#cb18-905" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input_Store"</span>: df[<span class="st">"Store"</span>].values.astype(<span class="bu">int</span>),</span>
<span id="cb18-906"><a href="#cb18-906" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input_numerical"</span>: df[cust_input_cols].values.astype(<span class="bu">float</span>)</span>
<span id="cb18-907"><a href="#cb18-907" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb18-908"><a href="#cb18-908" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> X</span>
<span id="cb18-909"><a href="#cb18-909" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-910"><a href="#cb18-910" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> prepare_inputs(train_set_nn)</span>
<span id="cb18-911"><a href="#cb18-911" aria-hidden="true" tabindex="-1"></a>X_val <span class="op">=</span> prepare_inputs(validation_set_nn)</span>
<span id="cb18-912"><a href="#cb18-912" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> prepare_inputs(test_set_nn)</span>
<span id="cb18-913"><a href="#cb18-913" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-914"><a href="#cb18-914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-915"><a href="#cb18-915" aria-hidden="true" tabindex="-1"></a>Most of the categorical features contain only around 3-5 classes, so converting them into dummy variables does not increase dimensionality (substantially). On the other hand, the $Store$ variable contains 1115 unique store identifiers. One-hot encoding this variable would add 1115 binary columns to the data, rendering it hardly usable to any model.</span>
<span id="cb18-916"><a href="#cb18-916" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-917"><a href="#cb18-917" aria-hidden="true" tabindex="-1"></a>::: {#fig-nn-embedding fig-cap="Example of the embedding process" fig-align="center"}</span>
<span id="cb18-920"><a href="#cb18-920" aria-hidden="true" tabindex="-1"></a><span class="in">```{mermaid}</span></span>
<span id="cb18-921"><a href="#cb18-921" aria-hidden="true" tabindex="-1"></a>flowchart LR</span>
<span id="cb18-922"><a href="#cb18-922" aria-hidden="true" tabindex="-1"></a>    D((Embedding model))</span>
<span id="cb18-923"><a href="#cb18-923" aria-hidden="true" tabindex="-1"></a>    subgraph Input[Input]</span>
<span id="cb18-924"><a href="#cb18-924" aria-hidden="true" tabindex="-1"></a>    A(Store: <span class="dv">1</span>) </span>
<span id="cb18-925"><a href="#cb18-925" aria-hidden="true" tabindex="-1"></a>    B(Store: <span class="dv">2</span>) </span>
<span id="cb18-926"><a href="#cb18-926" aria-hidden="true" tabindex="-1"></a>    dd(:)</span>
<span id="cb18-927"><a href="#cb18-927" aria-hidden="true" tabindex="-1"></a>    C(Store: <span class="dv">1115</span>)</span>
<span id="cb18-928"><a href="#cb18-928" aria-hidden="true" tabindex="-1"></a>    end</span>
<span id="cb18-929"><a href="#cb18-929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-930"><a href="#cb18-930" aria-hidden="true" tabindex="-1"></a>    A --&gt; D</span>
<span id="cb18-931"><a href="#cb18-931" aria-hidden="true" tabindex="-1"></a>    B --&gt; D</span>
<span id="cb18-932"><a href="#cb18-932" aria-hidden="true" tabindex="-1"></a>    C --&gt; D</span>
<span id="cb18-933"><a href="#cb18-933" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-934"><a href="#cb18-934" aria-hidden="true" tabindex="-1"></a>    subgraph Output[Output]</span>
<span id="cb18-935"><a href="#cb18-935" aria-hidden="true" tabindex="-1"></a>    F(<span class="ot">"</span><span class="st">[1.24, 4.15, ..., 2.53]</span><span class="ot">"</span>)</span>
<span id="cb18-936"><a href="#cb18-936" aria-hidden="true" tabindex="-1"></a>    G(<span class="ot">"</span><span class="st">[3.14, 2.71, ..., 1.61]</span><span class="ot">"</span>)</span>
<span id="cb18-937"><a href="#cb18-937" aria-hidden="true" tabindex="-1"></a>    ddd(:)</span>
<span id="cb18-938"><a href="#cb18-938" aria-hidden="true" tabindex="-1"></a>    H(<span class="ot">"</span><span class="st">[6.70, 6.98, ..., 4.27]</span><span class="ot">"</span>)</span>
<span id="cb18-939"><a href="#cb18-939" aria-hidden="true" tabindex="-1"></a>    end</span>
<span id="cb18-940"><a href="#cb18-940" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-941"><a href="#cb18-941" aria-hidden="true" tabindex="-1"></a>    D --&gt; F</span>
<span id="cb18-942"><a href="#cb18-942" aria-hidden="true" tabindex="-1"></a>    D --&gt; G</span>
<span id="cb18-943"><a href="#cb18-943" aria-hidden="true" tabindex="-1"></a>    D --&gt; H</span>
<span id="cb18-944"><a href="#cb18-944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-945"><a href="#cb18-945" aria-hidden="true" tabindex="-1"></a>    style A fill:<span class="co">#33628D,color:#FFF </span></span>
<span id="cb18-946"><a href="#cb18-946" aria-hidden="true" tabindex="-1"></a>    style B fill:<span class="co">#33628D,color:#FFF</span></span>
<span id="cb18-947"><a href="#cb18-947" aria-hidden="true" tabindex="-1"></a>    style C fill:<span class="co">#33628D,color:#FFF</span></span>
<span id="cb18-948"><a href="#cb18-948" aria-hidden="true" tabindex="-1"></a>    style dd fill:<span class="co">#33628D,color:#FFF</span></span>
<span id="cb18-949"><a href="#cb18-949" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-950"><a href="#cb18-950" aria-hidden="true" tabindex="-1"></a>    style D fill:<span class="co">#228C8D</span></span>
<span id="cb18-951"><a href="#cb18-951" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-952"><a href="#cb18-952" aria-hidden="true" tabindex="-1"></a>    style F fill:<span class="co">#31B57B,color:#FFF</span></span>
<span id="cb18-953"><a href="#cb18-953" aria-hidden="true" tabindex="-1"></a>    style G fill:<span class="co">#31B57B,color:#FFF</span></span>
<span id="cb18-954"><a href="#cb18-954" aria-hidden="true" tabindex="-1"></a>    style H fill:<span class="co">#31B57B,color:#FFF</span></span>
<span id="cb18-955"><a href="#cb18-955" aria-hidden="true" tabindex="-1"></a>    style ddd fill:<span class="co">#31B57B,color:#FFF</span></span>
<span id="cb18-956"><a href="#cb18-956" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-957"><a href="#cb18-957" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb18-958"><a href="#cb18-958" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-959"><a href="#cb18-959" aria-hidden="true" tabindex="-1"></a>For that reason we used embedding - the model learned the implications of the store numbers from the data, and saved them as a 10-dimensional vector. This way we reduced the dimensionality, while also preserving the original meaning of the variable.</span>
<span id="cb18-960"><a href="#cb18-960" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-963"><a href="#cb18-963" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb18-964"><a href="#cb18-964" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb18-965"><a href="#cb18-965" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb18-966"><a href="#cb18-966" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-967"><a href="#cb18-967" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_embedding_model(num_numerical_features, learning_rate<span class="op">=</span><span class="fl">0.001</span>):</span>
<span id="cb18-968"><a href="#cb18-968" aria-hidden="true" tabindex="-1"></a>    store_input <span class="op">=</span> Input(shape<span class="op">=</span>(<span class="dv">1</span>,), name<span class="op">=</span><span class="st">"input_Store"</span>)</span>
<span id="cb18-969"><a href="#cb18-969" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-970"><a href="#cb18-970" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Shrinking 1115 dimension spaces to a different vectors in R^10</span></span>
<span id="cb18-971"><a href="#cb18-971" aria-hidden="true" tabindex="-1"></a>    store_embed <span class="op">=</span> Embedding(input_dim<span class="op">=</span><span class="dv">1116</span>, output_dim<span class="op">=</span><span class="dv">10</span>, name<span class="op">=</span><span class="st">"embed_Store"</span>)(store_input)</span>
<span id="cb18-972"><a href="#cb18-972" aria-hidden="true" tabindex="-1"></a>    store_embed <span class="op">=</span> Flatten()(store_embed)</span>
<span id="cb18-973"><a href="#cb18-973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-974"><a href="#cb18-974" aria-hidden="true" tabindex="-1"></a>    num_input <span class="op">=</span> Input(shape<span class="op">=</span>(num_numerical_features,), name<span class="op">=</span><span class="st">"input_numerical"</span>)</span>
<span id="cb18-975"><a href="#cb18-975" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> Concatenate()([store_embed, num_input])</span>
<span id="cb18-976"><a href="#cb18-976" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-977"><a href="#cb18-977" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> Dense(<span class="dv">128</span>, activation<span class="op">=</span><span class="st">'relu'</span>)(merged)</span>
<span id="cb18-978"><a href="#cb18-978" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> Dropout(<span class="fl">0.2</span>)(x)</span>
<span id="cb18-979"><a href="#cb18-979" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> Dense(<span class="dv">128</span>, activation<span class="op">=</span><span class="st">'relu'</span>)(x)</span>
<span id="cb18-980"><a href="#cb18-980" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> Dropout(<span class="fl">0.2</span>)(x)</span>
<span id="cb18-981"><a href="#cb18-981" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> Dense(<span class="dv">128</span>, activation<span class="op">=</span><span class="st">'relu'</span>)(x)</span>
<span id="cb18-982"><a href="#cb18-982" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> Dropout(<span class="fl">0.2</span>)(x)</span>
<span id="cb18-983"><a href="#cb18-983" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-984"><a href="#cb18-984" aria-hidden="true" tabindex="-1"></a>    output <span class="op">=</span> Dense(<span class="dv">1</span>)(x)</span>
<span id="cb18-985"><a href="#cb18-985" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-986"><a href="#cb18-986" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> Model(inputs<span class="op">=</span>[store_input, num_input], outputs<span class="op">=</span>output)</span>
<span id="cb18-987"><a href="#cb18-987" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">compile</span>(optimizer<span class="op">=</span>Adam(learning_rate<span class="op">=</span>learning_rate), loss<span class="op">=</span><span class="st">"mse"</span>)</span>
<span id="cb18-988"><a href="#cb18-988" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-989"><a href="#cb18-989" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span>
<span id="cb18-990"><a href="#cb18-990" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-991"><a href="#cb18-991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-992"><a href="#cb18-992" aria-hidden="true" tabindex="-1"></a>num_feats_cust <span class="op">=</span> X_train[<span class="st">'input_numerical'</span>].shape[<span class="dv">1</span>]</span>
<span id="cb18-993"><a href="#cb18-993" aria-hidden="true" tabindex="-1"></a>model_cust <span class="op">=</span> build_embedding_model(num_numerical_features<span class="op">=</span>num_feats_cust)</span>
<span id="cb18-994"><a href="#cb18-994" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-995"><a href="#cb18-995" aria-hidden="true" tabindex="-1"></a>y_train_cust <span class="op">=</span> train_set_nn[<span class="st">'Customers_log'</span>].values</span>
<span id="cb18-996"><a href="#cb18-996" aria-hidden="true" tabindex="-1"></a>y_val_cust <span class="op">=</span> validation_set_nn[<span class="st">'Customers_log'</span>].values</span>
<span id="cb18-997"><a href="#cb18-997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-998"><a href="#cb18-998" aria-hidden="true" tabindex="-1"></a>callbacks_list <span class="op">=</span> [</span>
<span id="cb18-999"><a href="#cb18-999" aria-hidden="true" tabindex="-1"></a>    EarlyStopping(</span>
<span id="cb18-1000"><a href="#cb18-1000" aria-hidden="true" tabindex="-1"></a>        monitor<span class="op">=</span><span class="st">'val_loss'</span>, </span>
<span id="cb18-1001"><a href="#cb18-1001" aria-hidden="true" tabindex="-1"></a>        patience<span class="op">=</span><span class="dv">3</span>, </span>
<span id="cb18-1002"><a href="#cb18-1002" aria-hidden="true" tabindex="-1"></a>        restore_best_weights<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb18-1003"><a href="#cb18-1003" aria-hidden="true" tabindex="-1"></a>        verbose<span class="op">=</span><span class="dv">1</span></span>
<span id="cb18-1004"><a href="#cb18-1004" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-1005"><a href="#cb18-1005" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb18-1006"><a href="#cb18-1006" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1007"><a href="#cb18-1007" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1008"><a href="#cb18-1008" aria-hidden="true" tabindex="-1"></a>y_train_cust <span class="op">=</span> np.log1p(train_set[<span class="st">'Customers'</span>].values)</span>
<span id="cb18-1009"><a href="#cb18-1009" aria-hidden="true" tabindex="-1"></a>y_val_cust   <span class="op">=</span> np.log1p(validation_set[<span class="st">'Customers'</span>].values)</span>
<span id="cb18-1010"><a href="#cb18-1010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1011"><a href="#cb18-1011" aria-hidden="true" tabindex="-1"></a>history_cust <span class="op">=</span> model_cust.fit(</span>
<span id="cb18-1012"><a href="#cb18-1012" aria-hidden="true" tabindex="-1"></a>    X_train, y_train_cust,</span>
<span id="cb18-1013"><a href="#cb18-1013" aria-hidden="true" tabindex="-1"></a>    validation_data<span class="op">=</span>(X_val, y_val_cust),</span>
<span id="cb18-1014"><a href="#cb18-1014" aria-hidden="true" tabindex="-1"></a>    epochs<span class="op">=</span><span class="dv">50</span>, </span>
<span id="cb18-1015"><a href="#cb18-1015" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span><span class="dv">512</span>,</span>
<span id="cb18-1016"><a href="#cb18-1016" aria-hidden="true" tabindex="-1"></a>    callbacks<span class="op">=</span>callbacks_list,</span>
<span id="cb18-1017"><a href="#cb18-1017" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="dv">1</span></span>
<span id="cb18-1018"><a href="#cb18-1018" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-1019"><a href="#cb18-1019" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1020"><a href="#cb18-1020" aria-hidden="true" tabindex="-1"></a>pred_cust_log <span class="op">=</span> model_cust.predict(X_test, verbose<span class="op">=</span><span class="dv">0</span>).flatten()</span>
<span id="cb18-1021"><a href="#cb18-1021" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1022"><a href="#cb18-1022" aria-hidden="true" tabindex="-1"></a>pred_cust_real <span class="op">=</span> np.expm1(pred_cust_log)</span>
<span id="cb18-1023"><a href="#cb18-1023" aria-hidden="true" tabindex="-1"></a>pred_cust_real <span class="op">=</span> np.maximum(pred_cust_real, <span class="dv">0</span>)</span>
<span id="cb18-1024"><a href="#cb18-1024" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1025"><a href="#cb18-1025" aria-hidden="true" tabindex="-1"></a>is_open <span class="op">=</span> test_set[<span class="st">'Open'</span>].values</span>
<span id="cb18-1026"><a href="#cb18-1026" aria-hidden="true" tabindex="-1"></a>sample_preds <span class="op">=</span> pred_cust_real[is_open <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb18-1027"><a href="#cb18-1027" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-1028"><a href="#cb18-1028" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1031"><a href="#cb18-1031" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb18-1032"><a href="#cb18-1032" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-1033"><a href="#cb18-1033" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-1034"><a href="#cb18-1034" aria-hidden="true" tabindex="-1"></a><span class="fu">## 3.5 Results</span></span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>